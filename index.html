<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - æˆ°ç•¥å„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #111; 
            --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; 
            --sprint: #ff5722; --recover: #2196f3;
        }

        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: #000; color: white; margin: 0; padding: 0; 
            height: 100vh; overflow: hidden;
        }

        /* é é¢ç®¡ç† */
        .page { display: none; height: 100vh; width: 100vw; position: absolute; }
        .page.active { display: flex; flex-direction: column; }

        /* UI å…ƒä»¶ï¼šHeader */
        .header-bar {
            background: #222; padding: 10px 15px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 2px solid #333;
            height: 50px; box-sizing: border-box;
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .current-user-tag { color: var(--gold); font-weight: bold; font-size: 14px; }
        .btn-back { background: #444; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }

        /* 1. ç™»å…¥é  */
        #page-login { justify-content: center; align-items: center; background: #121212; }
        .login-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 85%; max-width: 400px; }
        .name-card { padding: 15px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 10px; font-weight: bold; text-align: center; }
        .name-card.taken { opacity: 0.2; pointer-events: none; }

        /* 2. é¸é¦¬é  (å›æ­¸å®Œæ•´ç‰ˆ) */
        #page-setup { background: #111; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .horse-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        .horse-card { 
            background: #222; border-radius: 15px; padding: 15px; border: 2px solid #333;
            transition: 0.3s; position: relative;
        }
        .horse-card.selected { border-color: var(--success); background: #1a2e1a; box-shadow: 0 0 15px rgba(76,175,80,0.3); }
        .horse-card.occupied { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        
        .horse-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .horse-trait { color: var(--gold); font-size: 18px; font-weight: bold; }
        
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-item { font-size: 11px; }
        .stat-label { color: #888; margin-bottom: 2px; display: block; }
        .stat-bar-bg { height: 6px; background: #000; border-radius: 3px; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: linear-gradient(90deg, #444, var(--gold)); }
        .horse-desc { font-size: 12px; color: #bbb; font-style: italic; line-height: 1.4; border-top: 1px solid #333; padding-top: 8px; }

        /* 3. æ¯”è³½é  */
        #page-track { background: #050505; }
        .race-container { flex-grow: 1; position: relative; }
        .lane { position: relative; border-bottom: 1px solid #222; width: 100%; box-sizing: border-box; }
        .horse-pawn { 
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            display: flex; align-items: center; width: 150px; transition: left 0.1s linear;
        }
        .horse-visual { font-size: 35px; transform: scaleX(-1); position: relative; }
        .stamina-float { position: absolute; top: 100%; left: 0; width: 50px; height: 4px; background: #000; border-radius: 2px; }
        .stamina-inner { height: 100%; background: var(--success); }

        /* æµ®å‹•æ°£æ³¡ */
        .event-bubble { 
            position: absolute; top: -45px; left: -10px; padding: 4px 12px; 
            border-radius: 20px; font-size: 12px; font-weight: bold; white-space: nowrap;
            animation: floatUp 0.5s infinite alternate; z-index: 10; display: none;
            border: 1px solid white;
        }
        @keyframes floatUp { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        /* 5ç§’å€’æ•¸æ•ˆæœ */
        .recovery-timer {
            position: absolute; top: -25px; left: 10px; font-weight: bold; color: var(--recover); font-size: 16px;
        }

        .finish-line { position: absolute; right: 80px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 2px solid gold; }

        /* 4. æ’è¡Œæ¦œ */
        #leaderboard-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .lb-box { background: white; color: #111; width: 85%; border-radius: 20px; padding: 25px; max-height: 80vh; overflow-y: auto; }

        /* Adminå·¥å…· */
        .admin-controls { position: fixed; bottom: 20px; left: 0; right: 0; display: none; justify-content: center; gap: 10px; z-index: 9999; }
        .btn-admin { padding: 12px 25px; border-radius: 30px; border: none; font-weight: bold; color: white; cursor: pointer; }
    </style>
</head>
<body>

<div class="header-bar" id="ui-header" style="display:none;">
    <div class="user-info">
        <span class="current-user-tag" id="label-user-name">å°šæœªç™»å…¥</span>
        <button class="btn-back" onclick="logout()">é‡é¸äººç‰©</button>
    </div>
    <div style="font-size:12px; opacity:0.6;">2026 AIOT</div>
</div>

<div id="page-login" class="page active">
    <h2 style="color:var(--gold); margin-bottom: 10px;">ğŸ’¼ AIOT å°¾ç‰™è³½é¦¬</h2>
    <p style="color:#888; margin-bottom: 30px;">è«‹é¸æ“‡æ‚¨çš„èº«ä»½é€²å…¥</p>
    <div class="login-grid" id="login-grid"></div>
</div>

<div id="page-setup" class="page">
    <div class="horse-list" id="horse-selection-list"></div>
</div>

<div id="page-track" class="page">
    <div class="race-container">
        <div class="finish-line"></div>
        <div id="lanes-render-area" style="height:100%;"></div>
    </div>
</div>

<div id="leaderboard-overlay">
    <div class="lb-box">
        <h2 style="text-align:center; color: var(--primary); margin-top:0;">ğŸ† æ±ºè³½æˆç¸¾ ğŸ†</h2>
        <div id="rankings-list"></div>
        <div id="admin-only-reset" style="display:none; margin-top:20px;">
            <button onclick="adminReset()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:10px; font-weight:bold;">é–‹å•Ÿä¸‹ä¸€è¼ª (å…¨å ´é‡è¨­)</button>
        </div>
        <p id="client-wait-msg" style="text-align:center; color:#888; font-size:12px; margin-top:15px;">ç­‰å¾…ç®¡ç†è€…ç™¼èµ·ä¸‹ä¸€å ´æ¯”è³½...</p>
    </div>
</div>

<div id="admin-panel" class="admin-controls">
    <button class="btn-admin" style="background:var(--success)" onclick="adminStart()">ğŸ é–‹å§‹æ¯”è³½</button>
    <button class="btn-admin" style="background:var(--primary)" onclick="adminReset()">ğŸ”„ é‡ç½®å…¨å ´</button>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 55, sta: 65, burst: 95, lck: 60}, desc: "ä¸€æ—¦å¤•é™½è¥¿ä¸‹ï¼Œé«”åŠ›å†ä½ä¹Ÿèƒ½çˆ†ç™¼è¡åˆºã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 85, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†çˆ†è‚å€’æ•¸æ˜¯ä»–çš„æ—¥å¸¸ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œä»¥ç©©å®šçš„é«˜èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 55}, desc: "ä¾è³´å’–å•¡å› æé€Ÿï¼Œæ²’å’–å•¡æ™‚é«”åŠ›æ‰è¶…å¿«ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ“æœ‰ç¥ç´šé–ƒé¿ï¼Œå¹¾ä¹ä¸æœƒæ»‘å€’ï¼Œé‹æ°£é»æ»¿ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 65}, desc: "é›–ç„¶æ²’å­˜åœ¨æ„Ÿï¼Œä½†é«”åŠ›é©šäººä¸”è·‘å¾—ç•°å¸¸ç©©ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 40, sta: 70, burst: 99, lck: 40}, desc: "å¹³æ™‚éƒ½åœ¨æ··ï¼Œæœ€å¾Œé—œé ­è¡åˆºåŠ›é‡ç„¡äººèƒ½åŠã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 65}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œçˆ†ç™¼åŠ›èˆ‡é€Ÿåº¦å…¼å…·çš„å‹ç”·ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†é«”åŠ›èˆ‡é‹æ°£è®“ä»–å§‹çµ‚åœ¨ç¬¬ä¸€æ¢¯éšŠã€‚" }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('race_user') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let serverOffset = 0;
    let currentStatus = "idle";

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());

    function init() {
        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'flex';
            document.getElementById('admin-only-reset').style.display = 'block';
            document.getElementById('client-wait-msg').style.display = 'none';
        }

        // åˆå§‹åŒ–ç™»å…¥ UI
        const loginGrid = document.getElementById('login-grid');
        names.forEach(n => {
            const d = document.createElement('div');
            d.className = 'name-card';
            d.id = `user-${n}`;
            d.innerText = n;
            d.onclick = () => login(n);
            loginGrid.appendChild(d);
        });

        // åˆå§‹åŒ–é¸é¦¬ UI (å›æ­¸å®Œæ•´ç‰ˆ)
        const setupGrid = document.getElementById('horse-selection-list');
        horseLibrary.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = 'horse-card';
            d.id = `slot-${i}`;
            d.innerHTML = `
                <div class="horse-header">
                    <span class="horse-trait">${h.trait}</span>
                    <span style="font-size:10px; opacity:0.5;">ID: STAFF_${i+1}</span>
                </div>
                <div class="stats-container">
                    ${renderStat('é€Ÿåº¦', h.stats.spd)}
                    ${renderStat('é«”åŠ›', h.stats.sta)}
                    ${renderStat('çˆ†ç™¼', h.stats.burst)}
                    ${renderStat('å¹¸é‹', h.stats.lck)}
                </div>
                <div class="horse-desc">${h.desc}</div>
            `;
            d.onclick = () => selectHorse(i);
            setupGrid.appendChild(d);
        });

        listenFirebase();
    }

    function renderStat(label, val) {
        return `
            <div class="stat-item">
                <span class="stat-label">${label}</span>
                <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${val}%"></div></div>
            </div>
        `;
    }

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function login(n) {
        myName = n;
        localStorage.setItem('race_user', n);
        db.ref(`users/${n}`).set(true);
    }

    function logout() {
        if(myName) {
            db.ref(`users/${myName}`).remove();
            db.ref(`assignments/${myName}`).remove();
        }
        localStorage.removeItem('race_user');
        location.reload();
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const u = snap.val() || {};
            names.forEach(n => {
                const el = document.getElementById(`user-${n}`);
                u[n] ? el.classList.add('taken') : el.classList.remove('taken');
            });
            if (myName && u[myName]) {
                switchPage('page-setup');
                document.getElementById('ui-header').style.display = 'flex';
                document.getElementById('label-user-name').innerText = myName;
            } else {
                switchPage('page-login');
                document.getElementById('ui-header').style.display = 'none';
            }
        });

        db.ref('assignments').on('value', snap => {
            const a = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const el = document.getElementById(`slot-${i}`);
                if(!el) return;
                const owner = Object.keys(a).find(k => a[k] === i);
                el.className = 'horse-card';
                if (owner === myName) el.classList.add('selected');
                else if (owner) el.classList.add('occupied');
            });
        });

        db.ref('gameState').on('value', snap => {
            const s = snap.val();
            if (!s) return;
            currentStatus = s.status;
            if (s.status === 'racing') runRace(s);
            if (s.status === 'idle' && document.getElementById('page-track').classList.contains('active')) {
                location.reload();
            }
        });
    }

    // ç®¡ç†è€…ï¼šç”ŸæˆåŠ‡æœ¬
    function adminStart() {
        db.ref('assignments').once('value', snap => {
            const players = snap.val();
            if (!players) return alert("é‚„æ²’äººé¸é¦¬ï¼");
            
            const raceData = {};
            Object.entries(players).forEach(([name, hIdx]) => {
                const h = horseLibrary[hIdx];
                // æ ¹æ“š Luck æ±ºå®šäº‹ä»¶æ©Ÿç‡
                const eventCount = 2 + Math.floor(h.stats.lck / 30);
                const events = [];
                for(let j=0; j<eventCount; j++) {
                    const t = 5 + (j * 8) + Math.random() * 5;
                    // å¹¸é‹è¶Šé«˜ï¼Œè¶Šå®¹æ˜“è¡åˆºè€Œéæ»‘å€’
                    const type = (Math.random() * 100 < h.stats.lck) ? 'burst' : 'slip';
                    events.push({ t, type });
                }
                
                raceData[name] = { hIdx, events };
            });

            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + serverOffset + 3000,
                raceData
            });
        });
    }

    function adminReset() {
        if(confirm("ç¢ºå®šçµæŸæ¯”è³½ä¸¦æ¸…ç©ºæ‰€æœ‰äººç™»å…¥ç‹€æ…‹ï¼Ÿ")) {
            db.ref().set({ gameState: { status: 'idle' } });
        }
    }

    // ç¢ºå®šæ€§åŒæ­¥å¼•æ“
    function runRace(state) {
        switchPage('page-track');
        document.getElementById('ui-header').style.display = 'none';
        const renderArea = document.getElementById('lanes-render-area');
        renderArea.innerHTML = "";
        
        const players = Object.entries(state.raceData);
        const laneH = 100 / Math.max(players.length, 5);
        
        // æ¸²æŸ“è³½é“
        players.forEach(([name, data], idx) => {
            const div = document.createElement('div');
            div.className = 'lane';
            div.style.height = `${laneH}%`;
            div.innerHTML = `
                <div class="horse-pawn" id="pawn-${idx}">
                    <div class="event-bubble" id="bubble-${idx}"></div>
                    <div class="recovery-timer" id="timer-${idx}"></div>
                    <div class="horse-visual">ğŸ</div>
                    <div style="margin-left:10px;">
                        <div style="font-size:12px; font-weight:bold;">${name}</div>
                        <div class="stamina-float"><div class="stamina-inner" id="stam-${idx}"></div></div>
                    </div>
                </div>
            `;
            renderArea.appendChild(div);
        });

        const finishLineX = renderArea.offsetWidth - 130;
        const FPS = 60;
        const interval = 1000 / FPS;

        // æ¯ä½ç©å®¶çš„å³æ™‚ç‹€æ…‹ (æ¯å°è¨­å‚™ç¨ç«‹é‹è¡Œä½†çµæœä¸€è‡´)
        const localState = players.map(([name, data]) => {
            const h = horseLibrary[data.hIdx];
            return {
                name,
                stats: h.stats,
                events: data.events,
                progress: 0,
                stamina: 100,
                isRecovering: false,
                recoveryEndTime: 0,
                finished: false
            };
        });

        function update() {
            const now = Date.now() + serverOffset;
            const elapsed = (now - state.startTime) / 1000;
            if (elapsed < 0) { requestAnimationFrame(update); return; }

            localState.forEach((p, i) => {
                if (p.finished) return;

                const el = document.getElementById(`pawn-${i}`);
                const bub = document.getElementById(`bubble-${i}`);
                const sInner = document.getElementById(`stam-${i}`);
                const timerEl = document.getElementById(`timer-${i}`);

                // 1. æ¢å¾©é‚è¼¯ (çˆ†è‚æ‡²ç½°)
                if (p.isRecovering) {
                    const timeLeft = Math.ceil(p.recoveryEndTime - elapsed);
                    timerEl.innerText = timeLeft > 0 ? `ğŸ¤® çˆ†è‚ä¸­..${timeLeft}s` : "";
                    if (elapsed >= p.recoveryEndTime) {
                        p.isRecovering = false;
                        p.stamina = 100; // æ»¿è¡€å›æ­¸
                        timerEl.innerText = "";
                    }
                } else {
                    // 2. æ­£å¸¸è·‘å‹•é‚è¼¯
                    let currentSpd = p.stats.spd * 0.005;
                    let drainRate = (1.5 - p.stats.sta / 100) * 0.15; // åŸºç¤æ¶ˆè€—

                    // äº‹ä»¶å½±éŸ¿
                    let eventActive = false;
                    p.events.forEach(ev => {
                        if (elapsed >= ev.t && elapsed <= ev.t + 2) {
                            eventActive = true;
                            if (ev.type === 'burst') {
                                currentSpd *= (1.5 + p.stats.burst / 100);
                                drainRate *= 3; // è¡åˆºæ‰£é«”åŠ›è¶…å¿«
                                bub.innerText = "âš¡ è¡åˆºï¼";
                                bub.style.background = "var(--sprint)";
                                bub.style.display = "block";
                            } else {
                                p.progress = Math.max(0, p.progress - 0.005); // æ»‘å€’å¾€å¾Œé€€
                                bub.innerText = "â›¸ï¸ æ»‘å€’ï¼";
                                bub.style.background = "#555";
                                bub.style.display = "block";
                            }
                        }
                    });
                    if(!eventActive) bub.style.display = "none";

                    // æ›´æ–°é€²åº¦èˆ‡é«”åŠ›
                    p.progress += currentSpd;
                    p.stamina = Math.max(0, p.stamina - drainRate);
                    sInner.style.width = p.stamina + "%";
                    sInner.style.background = p.stamina < 20 ? 'var(--danger)' : 'var(--success)';

                    // æª¢æŸ¥æ˜¯å¦é«”åŠ›è€—ç›¡
                    if (p.stamina <= 0) {
                        p.isRecovering = true;
                        p.recoveryEndTime = elapsed + 5; // 5ç§’ç½°ç«™
                    }
                }

                // æ›´æ–°ä½ç½®
                el.style.left = (p.progress * finishLineX) + "px";

                // æŠµé”çµ‚é»
                if (p.progress >= 1) {
                    p.finished = true;
                    p.finishTime = elapsed;
                }
            });

            if (localState.every(p => p.finished)) {
                showLeaderboard(localState);
            } else {
                requestAnimationFrame(update);
            }
        }
        requestAnimationFrame(update);
    }

    function showLeaderboard(results) {
        const sorted = [...results].sort((a,b) => a.finishTime - b.finishTime);
        document.getElementById('leaderboard-overlay').style.display = 'flex';
        const list = document.getElementById('rankings-list');
        list.innerHTML = sorted.map((r, i) => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; font-weight:bold;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:var(--primary)">${getPrize(i+1)}</span>
            </div>
        `).join('');
    }

    function getPrize(r) {
        if (r === 1) return "$2500";
        if (r <= 5) return "$1000ç¦®åˆ¸";
        return {6:"$500", 7:"$400", 8:"$300", 9:"$200", 10:"$100"}[r] || "-";
    }

    init();
</script>
</body>
</html>
