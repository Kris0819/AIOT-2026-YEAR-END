<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - çé‡‘é ’çå„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; 
            --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; 
        }

        body { 
            font-family: 'PingFang TC', sans-serif; background: #000; color: white; 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
        }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
        .user-status-bar {
            background: rgba(255,255,255,0.1); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; font-size: 14px;
        }
        .logout-btn { background: none; border: 1px solid #666; color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 12px; }

        /* é¸äººç•«é¢ */
        #user-login { 
            position: fixed; inset: 0; background: #121212; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; max-width: 400px; }
        .name-btn { padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; font-weight: bold; }
        .name-btn.taken { opacity: 0.3; pointer-events: none; text-decoration: line-through; }

        /* é¸é¦¬ç•«é¢è¦–è¦ºåŒ– */
        #setup { display: none; height: calc(100vh - 50px); overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .horse-slot { 
            background: #222; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            border: 2px solid #333; position: relative;
        }
        .horse-slot.my-pick { border-color: var(--success); background: #1a2e1a; }
        .horse-slot.occupied { opacity: 0.5; filter: grayscale(1); }

        /* è¦–è¦ºåŒ–èƒ½åŠ›å€¼æ¢ */
        .stat-viz { margin-top: 10px; }
        .stat-line { display: flex; align-items: center; margin-bottom: 4px; font-size: 12px; }
        .stat-label { width: 40px; color: #aaa; }
        .stat-bar-bg { flex-grow: 1; height: 6px; background: #000; border-radius: 3px; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: linear-gradient(90deg, #555, var(--gold)); border-radius: 3px; }

        /* è³½é“ */
        #track { display: none; height: 100vh; width: 100vw; background: #111; position: relative; }
        .lane { position: relative; border-bottom: 1px solid #222; display: flex; align-items: center; width: 100%; }
        .horse-container { position: absolute; left: 0; display: flex; align-items: center; width: 120px; will-change: left; }
        .horse-icon { font-size: 30px; transform: scaleX(-1); }
        .finish-line { position: absolute; right: 50px; top: 0; bottom: 0; width: 10px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); }

        /* ç®¡ç†è€…å·¥å…· */
        .admin-controls { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; z-index: 2000; }
        .admin-btn { padding: 12px 25px; border-radius: 25px; border: none; font-weight: bold; color: white; }

        /* çµç®— */
        #leaderboard { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .prize-box { background: white; color: black; width: 85%; border-radius: 15px; padding: 20px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<audio id="bgm" loop src="https://actions.google.com/sounds/v1/sports/crowd_cheer.ogg"></audio>
<audio id="race-bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>

<div class="user-status-bar" id="status-bar" style="display:none;">
    <span>ç›®å‰è§’è‰²: <b id="display-name" style="color:var(--gold)"></b></span>
    <button class="logout-btn" onclick="logout()">é‡é¸äººç‰©</button>
</div>

<div id="user-login">
    <h2 style="color:var(--gold)">ğŸ’¼ 2026 AIOT å°¾ç‰™è³½é¦¬</h2>
    <p>è«‹é¸æ“‡æ‚¨çš„èº«ä»½</p>
    <div class="name-grid" id="name-grid"></div>
</div>

<div id="setup">
    <h3 style="text-align:center">è«‹æŒ‘é¸ä½ çš„æˆ°é¦¬</h3>
    <div id="select-grid"></div>
</div>

<div id="track">
    <div class="finish-line"></div>
    <div id="lanes-box" style="height:100%"></div>
</div>

<div id="admin-panel" class="admin-controls" style="display:none;">
    <button class="admin-btn" style="background:var(--success)" onclick="startRace()">ğŸ é–‹å§‹éŠæˆ²</button>
    <button class="admin-btn" style="background:var(--primary)" onclick="resetGame()">ğŸ”„ é‡ç½®å…¨å ´</button>
</div>

<div id="leaderboard">
    <div class="prize-box">
        <h2 style="text-align:center;color:var(--primary)">ğŸ† æœ€çµ‚åæ¬¡ ğŸ†</h2>
        <div id="leaderboard-list"></div>
        <button onclick="location.reload()" style="width:100%; padding:12px; margin-top:15px; border-radius:8px;">é—œé–‰</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ¢æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "å¹³æ™‚ç¯€èƒ½æ¨¡å¼ï¼Œä¸€æ—¦å¤•é™½è¥¿ä¸‹ä¾¿é–‹å•Ÿè¶…é »æ¨¡å¼ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†éœ€æ³¨æ„å¥åº·è­¦è¨Šã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œèƒ½ä»¥ç©©å®šçš„èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "ä¾è³´èˆˆå¥®åŠ‘ï¼Œé€Ÿåº¦å–æ±ºæ–¼æ—©ä¸Šçš„æ‹¿éµæ¿ƒåº¦ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ“æœ‰ç¥ç´šé–ƒé¿ï¼Œä»»ä½•éšœç¤™èˆ‡è²¬ä»»éƒ½ç¢°ä¸åˆ°ç‰ ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "æ²’äººæ³¨æ„åˆ°ç‰ å·²æ‚„æ‚„è·‘åˆ°æœ€å‰é¢ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "åœ¨æœ€å¾Œä¸€ç§’å‰ï¼Œä½ æ°¸é ä¸çŸ¥é“ç‰ æœƒçˆ†ç™¼ä»€éº¼ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œé€Ÿåº¦å¿«åˆ°è®“äººç„¡æ³•åé§ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†çµ•å°æ´»å¾—æ¯”ä»»ä½•é¦¬éƒ½ä¹…ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('race_user') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let serverTimeOffset = 0;

    // æ ¡æ­£ä¼ºæœå™¨æ™‚é–“
    db.ref(".info/serverTimeOffset").on("value", (snap) => {
        serverTimeOffset = snap.val();
    });

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'flex';
        renderLogin();
        renderSelection();
        listenFirebase();
    }

    function renderLogin() {
        const grid = document.getElementById('name-grid');
        grid.innerHTML = "";
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `login-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            grid.appendChild(btn);
        });
    }

    function renderSelection() {
        const grid = document.getElementById('select-grid');
        grid.innerHTML = "";
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between">
                    <b>${h.trait}</b> <span style="font-size:10px; color:#666">STAFF-${i+1}</span>
                </div>
                <div class="stat-viz">
                    ${Object.entries(h.stats).map(([k, v]) => `
                        <div class="stat-line">
                            <span class="stat-label">${translateStat(k)}</span>
                            <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${v}%"></div></div>
                        </div>
                    `).join('')}
                </div>
                <p style="font-size:11px; color:#888; margin-top:8px;">${h.desc}</p>
            `;
            div.onclick = () => selectHorse(i);
            grid.appendChild(div);
        });
    }

    function translateStat(s) { const m = {spd:'é€Ÿåº¦', sta:'é«”åŠ›', burst:'çˆ†ç™¼', lck:'å¹¸é‹'}; return m[s]; }

    function login(n) {
        myName = n;
        localStorage.setItem('race_user', n);
        db.ref(`users/${n}`).set(true);
        document.getElementById('bgm').play().catch(()=>{});
    }

    function logout() {
        if (myName) db.ref(`users/${myName}`).remove();
        if (myName) db.ref(`assignments/${myName}`).remove();
        myName = "";
        localStorage.removeItem('race_user');
        location.reload();
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        // åŒæ­¥ç™»å…¥ç‹€æ…‹
        db.ref('users').on('value', snap => {
            const val = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`login-${n}`);
                if (val[n]) btn.classList.add('taken');
                else btn.classList.remove('taken');
            });
            if (myName && val[myName]) {
                document.getElementById('user-login').style.display = 'none';
                document.getElementById('status-bar').style.display = 'flex';
                document.getElementById('setup').style.display = 'block';
                document.getElementById('display-name').innerText = myName;
            }
        });

        // åŒæ­¥é¦¬åŒ¹é¸æ“‡
        db.ref('assignments').on('value', snap => {
            const val = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                const owner = Object.keys(val).find(k => val[k] === i);
                slot.className = 'horse-slot';
                if (owner === myName) slot.classList.add('my-pick');
                else if (owner) slot.classList.add('occupied');
            });
        });

        // ç›£è½æ¯”è³½é–‹å§‹
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing') {
                runRace(state);
            } else if (state && state.status === 'idle' && document.getElementById('track').style.display === 'block') {
                location.reload();
            }
        });
    }

    // ç®¡ç†è€…ï¼šç”ŸæˆåŠ‡æœ¬
    function startRace() {
        db.ref('assignments').once('value', snap => {
            const players = snap.val();
            if (!players) return alert("æ²’äººé¸é¦¬ï¼");
            
            const raceData = {};
            Object.entries(players).forEach(([name, horseIdx]) => {
                const stats = horseLibrary[horseIdx].stats;
                // æ±ºå®šç¸½å¥”è·‘æ™‚é–“ (25~35ç§’é–“)
                const baseTime = 30 - (stats.spd / 10) + (Math.random() * 5);
                raceData[name] = {
                    horseIdx,
                    totalTime: baseTime,
                    shake: 2 + Math.random() * 3 // è·‘æ­¥æŠ–å‹•æ„Ÿ
                };
            });

            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + serverTimeOffset + 3000, // 3ç§’å¾Œå€’æ•¸é–‹å§‹
                raceData: raceData
            });
        });
    }

    function resetGame() {
        if (confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) db.ref().set({ gameState: { status: 'idle' } });
    }

    // æ ¸å¿ƒï¼šåŠ‡æœ¬æ’­æ”¾å¼•æ“
    function runRace(state) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('status-bar').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('bgm').pause();
        document.getElementById('race-bgm').play().catch(()=>{});

        const box = document.getElementById('lanes-box');
        box.innerHTML = "";
        const participants = Object.entries(state.raceData);
        const laneH = 100 / participants.length;

        participants.forEach(([name, data], idx) => {
            const div = document.createElement('div');
            div.className = 'lane';
            div.style.height = `${laneH}%`;
            div.innerHTML = `
                <div class="horse-container" id="horse-${idx}">
                    <div class="horse-icon">ğŸ</div>
                    <div style="font-size:12px;">${name}</div>
                </div>
            `;
            box.appendChild(div);
        });

        const finishX = document.getElementById('track').offsetWidth - 120;

        function frame() {
            const now = Date.now() + serverTimeOffset;
            const elapsed = (now - state.startTime) / 1000;

            if (elapsed < 0) {
                requestAnimationFrame(frame);
                return;
            }

            let allFinished = true;
            const results = [];

            participants.forEach(([name, data], idx) => {
                const el = document.getElementById(`horse-${idx}`);
                // æ ¹æ“šé€²åº¦ç™¾åˆ†æ¯”è¨ˆç®—ä½ç½®ï¼š (å·²éæ™‚é–“ / ç¸½æ™‚é–“)
                let progress = Math.min(1, elapsed / data.totalTime);
                let currentX = progress * finishX;
                
                // åŠ å…¥ä¸€é»é»ç‰©ç†éœ‡å‹•æ„Ÿ
                let sway = progress < 1 ? Math.sin(elapsed * 15) * data.shake : 0;
                el.style.left = currentX + "px";
                el.style.top = (sway + 10) + "px";

                if (progress < 1) allFinished = false;
                results.push({ name, time: data.totalTime });
            });

            if (!allFinished) {
                requestAnimationFrame(frame);
            } else {
                setTimeout(() => showFinal(results), 1000);
            }
        }
        requestAnimationFrame(frame);
    }

    function showFinal(results) {
        const sorted = results.sort((a,b) => a.time - b.time);
        document.getElementById('leaderboard').style.display = 'flex';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = sorted.map((r, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; font-weight:bold">
                <span>#${i+1} ${r.name}</span>
                <span style="color:var(--primary)">${getPrize(i+1)}</span>
            </div>
        `).join('');
    }

    function getPrize(rank) {
        if (rank === 1) return "$2500";
        if (rank <= 5) return "$1000ç¦®åˆ¸";
        const others = {6:"$500", 7:"$400", 8:"$300", 9:"$200", 10:"$100"};
        return others[rank] || "$0";
    }

    init();
</script>
</body>
</html>
