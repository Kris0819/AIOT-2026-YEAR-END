<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å°ˆæ¥­åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        body { font-family: 'PingFang TC', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç°¡ç´„ Admin å·¥å…·åˆ— */
        #admin-toolbar { position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; gap: 20px; padding: 10px; z-index: 9999; border-bottom: 1px solid var(--gold); }
        .admin-btn { padding: 8px 20px; border-radius: 5px; border: 1px solid white; background: transparent; color: white; cursor: pointer; font-weight: bold; }

        /* é¸äººç•«é¢ - è¡Œå‹•å„ªåŒ– */
        #user-login { background: #1e1e1e; padding: 20px; border-radius: 20px; text-align: center; z-index: 200; position: fixed; top: 50%; transform: translateY(-50%); width: 85%; border: 2px solid var(--gold); }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .name-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; font-size: 16px; font-weight: bold; }
        .name-btn.taken { opacity: 0.2; pointer-events: none; }
        .name-btn.me { background: var(--success); border-color: white; }

        /* é¸é¦¬ç•«é¢ - å¡ç‰‡åŒ– */
        .setup-area { background: #1e1e1e; padding: 15px; width: 100%; flex-grow: 1; overflow-y: auto; display: none; }
        .horse-select-grid { display: flex; flex-direction: column; gap: 12px; padding-bottom: 50px; }
        .horse-slot { background: #252525; padding: 15px; border-radius: 12px; border: 2px solid #333; position: relative; }
        .horse-slot.occupied { opacity: 0.4; pointer-events: none; }
        .horse-slot.my-pick { border-color: var(--success); box-shadow: 0 0 10px var(--success); }
        .occupied-label { position: absolute; top: 10px; right: 10px; background: var(--primary); font-size: 12px; padding: 2px 8px; border-radius: 4px; }

        /* å±¬æ€§æ¢ */
        .stat-row { display: flex; align-items: center; margin-top: 4px; font-size: 11px; }
        .stat-bar { flex-grow: 1; height: 6px; background: #000; border-radius: 3px; margin-left: 10px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--gold); }

        /* è³½é“å€ - çµ•å°åŒæ­¥ä½ˆå±€ */
        .track-container { position: relative; width: 100%; flex-grow: 1; background: var(--track-bg); display: none; overflow: hidden; }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); opacity: 0.3; }
        .lane { position: relative; border-bottom: 1px dashed rgba(255,255,255,0.1); width: 100%; display: flex; align-items: center; }
        .horse-container { position: absolute; left: 0; display: flex; align-items: center; z-index: 10; transition: transform 0.1s linear; }
        .horse-icon { font-size: 30px; transform: scaleX(-1); }

        /* æ’è¡Œæ¦œ */
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: white; color: #111; border-radius: 20px; padding: 20px; z-index: 1000; display: none; border: 5px solid var(--gold); }
        .prize-text { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div id="admin-toolbar">
        <button class="admin-btn" onclick="triggerStart()">ğŸ é–‹å§‹æ¯”è³½</button>
        <button class="admin-btn" style="border-color: red;" onclick="resetData()">ğŸ”„ é‡ç½®æ•¸æ“š</button>
    </div>

    <h2 id="main-title" style="margin: 15px 0; color: var(--gold); font-size: 1.2rem;">2026 AIOT å°¾ç‰™è³½é¦¬</h2>

    <div id="user-login">
        <h3 style="margin:0;">è«‹é»é¸æ‚¨çš„åå­—</h3>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0;">ğŸ† æ¯”è³½çµæœ</h2>
        <div id="leaderboard-list" style="margin-top: 15px;"></div>
        <button onclick="location.reload()" style="width:100%; padding:12px; margin-top:15px; background: #333; color: white; border-radius: 10px; font-weight: bold;">è¿”å›</button>
    </div>

<script>
    // --- Firebase é…ç½® (ä¿æŒæ‚¨çš„è¨­å®š) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70} },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60} },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30} },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80} },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50} },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99} },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60} },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40} },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60} },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70} }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    const colors = ["#FF5252", "#FFD700", "#E040FB", "#00E676", "#2979FF", "#FF9100", "#40C4FF", "#FF1744", "#F4FF81", "#B2FF59"];

    let myName = localStorage.getItem('my_race_name') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;

    function init() {
        if (isAdmin) document.getElementById('admin-toolbar').style.display = 'flex';
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => {
                myName = n;
                localStorage.setItem('my_race_name', n);
                db.ref(`users/${n}`).set(true);
            };
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="font-size:18px; font-weight:bold; color:var(--gold);">${h.trait}</div>
                <div class="stat-row">é€Ÿåº¦ <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                <div class="stat-row">é«”åŠ› <div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
            `;
            div.onclick = () => { if(myName) db.ref(`assignments/${myName}`).set(i); };
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const val = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                btn.className = `name-btn ${val[n] ? 'taken' : ''} ${n === myName ? 'me' : ''}`;
                if(n === myName && val[n]) {
                    document.getElementById('user-login').style.display = 'none';
                    document.getElementById('setup').style.display = 'block';
                }
            });
        });

        db.ref('assignments').on('value', snap => {
            const val = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const label = slot.querySelector('.occupied-label'); if(label) label.remove();
                
                const owner = Object.keys(val).find(k => val[k] === i);
                if(owner) {
                    if(owner === myName) slot.classList.add('my-pick');
                    else {
                        slot.classList.add('occupied');
                        const l = document.createElement('div'); l.className='occupied-label'; l.innerText=owner;
                        slot.appendChild(l);
                    }
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) {
                runSynchronizedRace(state);
            } else if (!state && raceStarted) {
                location.reload();
            }
        });
    }

    // --- åŒæ­¥æ ¸å¿ƒå¼•æ“ ---
    function runSynchronizedRace(state) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('main-title').style.display = 'none';

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = '';
        
        const participants = Object.keys(state.participants).map((name, idx) => ({
            name, horse: horseLibrary[state.participants[name]], color: colors[idx % colors.length]
        }));

        const laneHeight = 100 / participants.length;
        participants.forEach((p, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `<div class="horse-container" id="h-container-${idx}">
                <div class="horse-icon" style="color:${p.color}">ğŸ</div>
                <div style="font-size:10px; margin-left:5px;">${p.name}</div>
            </div>`;
            lanesBox.appendChild(lane);
        });

        const trackWidth = document.getElementById('track').offsetWidth - 80;
        const raceDuration = 30000; // 30ç§’åˆ†å‹è² 

        const syncInterval = setInterval(() => {
            const now = Date.now();
            const elapsed = now - state.startTime;
            const progress = Math.min(elapsed / raceDuration, 1.1); // 0 ~ 1.1

            if (progress < 0) return; // é‚„æ²’é–‹å§‹

            participants.forEach((p, idx) => {
                // ç¢ºå®šæ€§éš¨æ©Ÿï¼šä½¿ç”¨ seed + ç´¢å¼•ï¼Œç¢ºä¿æ¯å€‹äººç®—å‡ºä¾†çš„éš¨æ©ŸæŠ–å‹•éƒ½ä¸€æ¨£
                const horseSeed = state.seed + idx;
                const jitter = Math.sin(elapsed / 500 + horseSeed) * 15; // éš¨æ©Ÿå°è¶…è»Šæ„Ÿ
                
                // æ ¹æ“šé¦¬åŒ¹å±¬æ€§å¾®èª¿é€²åº¦
                const statMod = (p.horse.stats.spd / 100) * 0.1;
                const horseProgress = progress * (0.9 + statMod);

                const x = (horseProgress * trackWidth) + jitter;
                const el = document.getElementById(`h-container-${idx}`);
                el.style.transform = `translateX(${Math.max(0, x)}px)`;
            });

            if (progress >= 1.1) {
                clearInterval(syncInterval);
                showResults(participants, state.seed);
            }
        }, 50);
    }

    function showResults(list, seed) {
        // ä½¿ç”¨ç›¸åŒ Seed è¨ˆç®—çµæœï¼Œä¿è­‰æ’è¡ŒåŒæ­¥
        const results = list.map((p, idx) => ({
            name: p.name,
            finalScore: p.horse.stats.spd + (Math.sin(seed + idx) * 20)
        })).sort((a, b) => b.finalScore - a.score); // ä¿®æ­£æ’åºé‚è¼¯
        
        // ä¿®æ­£æ’åºç‚ºç”±å¤§åˆ°å°
        results.sort((a, b) => b.finalScore - a.finalScore);

        const listEl = document.getElementById('leaderboard-list');
        listEl.innerHTML = '';
        results.forEach((r, i) => {
            const rank = i + 1;
            let prize = rank === 1 ? "$2500" : (rank <= 5 ? "$1000åˆ¸" : "$100");
            listEl.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <span>#${rank} ${r.name}</span>
                <span class="prize-text">${prize}</span>
            </div>`;
        });
        document.getElementById('leaderboard').style.display = 'block';
    }

    function triggerStart() {
        db.ref('assignments').once('value', snap => {
            const p = snap.val();
            if(!p) return alert("é‚„æ²’æœ‰äººé¸é¦¬å–”ï¼");
            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + 3000, // 3ç§’å¾Œçµ±ä¸€é–‹å§‹ï¼Œé ç•™è¼‰å…¥æ™‚é–“
                seed: Math.random(),
                participants: p
            });
        });
    }

    function resetData() {
        if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) {
            db.ref().set(null);
            localStorage.clear();
            location.reload();
        }
    }

    init();
</script>
</body>
</html>
