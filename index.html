<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - çµ•å°åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        body { font-family: 'PingFang TC', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç®¡ç†è€…å·¥å…· */
        #admin-toolbar { position: fixed; top: 10px; right: 10px; display: none; z-index: 9999; }
        .admin-btn { padding: 5px 10px; background: rgba(0,0,0,0.6); color: white; border: 1px solid #666; border-radius: 4px; font-size: 12px; cursor: pointer; }

        /* ä½¿ç”¨è€…ç‹€æ…‹æ¬„ */
        .user-status-bar { width: 100%; padding: 10px; background: #1e1e1e; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .btn-back { padding: 4px 12px; background: #444; border: none; color: white; border-radius: 4px; cursor: pointer; }

        /* é¸äºº/é¸é¦¬ç•«é¢ */
        .overlay-screen { background: #121212; position: fixed; inset: 0; padding: 20px; z-index: 100; overflow-y: auto; text-align: center; }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .name-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; font-weight: bold; font-size: 16px; }
        .name-btn.taken { opacity: 0.2; pointer-events: none; }
        
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-top: 15px; }
        .horse-slot { background: #252525; padding: 10px; border-radius: 10px; border: 2px solid #333; position: relative; text-align: left; }
        .horse-slot.occupied { opacity: 0.3; pointer-events: none; }
        .horse-slot.my-pick { border-color: var(--success); background: #1a2e1a; }
        .occupied-name { position: absolute; top: 5px; right: 5px; font-size: 10px; background: var(--primary); padding: 2px 5px; border-radius: 3px; }

        /* è³½é“ */
        .track-container { position: relative; width: 100%; flex-grow: 1; background: var(--track-bg); display: none; overflow: hidden; }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); opacity: 0.2; }
        .lane { position: relative; width: 100%; border-bottom: 1px dashed rgba(255,255,255,0.05); }
        .horse-container { position: absolute; left: 0; top: 50%; transform: translateY(-50%); display: flex; align-items: center; will-change: left; }
        .horse-icon { font-size: 28px; transform: scaleX(-1); }
        
        #start-btn { position: fixed; bottom: 30px; padding: 15px 60px; font-size: 20px; background: var(--primary); color: white; border: none; border-radius: 30px; font-weight: bold; display: none; z-index: 50; }
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: white; color: black; border-radius: 15px; padding: 20px; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="admin-toolbar">
        <button class="admin-btn" onclick="resetData()">é‡ç½®éŠæˆ²</button>
    </div>

    <div id="screen-login" class="overlay-screen">
        <h2 style="color:var(--gold)">WHO ARE YOU?</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="screen-setup" class="overlay-screen" style="display:none;">
        <div class="user-status-bar">
            <span>ç•¶å‰èº«åˆ†ï¼š<b id="display-my-name" style="color:var(--gold)"></b></span>
            <button class="btn-back" onclick="backToLogin()">è¿”å›é‡é¸</button>
        </div>
        <h3 style="margin: 15px 0;">è«‹æŒ‘é¸æˆ°é¦¬</h3>
        <div class="horse-select-grid" id="select-grid"></div>
        <button id="start-btn" onclick="triggerStart()">ğŸ é–‹å§‹æ¯”è³½</button>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0;">ğŸ† æ¯”è³½çµæœ</h2>
        <div id="leaderboard-list" style="margin: 15px 0;"></div>
        <button onclick="location.reload()" style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:8px;">è¿”å›</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
        authDomain: "aiot-d53dc.firebaseapp.com",
        databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
        projectId: "aiot-d53dc",
        storageBucket: "aiot-d53dc.firebasestorage.app",
        messagingSenderId: "1021331253049",
        appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
        measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 0.8, sta: 1.2 },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 0.7, sta: 0.9 },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 1.2, sta: 0.4 },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", spd: 0.9, sta: 0.8 },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’", spd: 1.0, sta: 0.7 },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", spd: 0.6, sta: 1.5 },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", spd: 0.85, sta: 1.1 },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", spd: 0.5, sta: 1.0 },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", spd: 1.1, sta: 0.6 },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", spd: 0.9, sta: 0.9 }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('my_race_name') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    function init() {
        if (isAdmin) {
            document.getElementById('admin-toolbar').style.display = 'block';
            document.getElementById('start-btn').style.display = 'block';
        }
        
        // ç”Ÿæˆå§“åæŒ‰éˆ•
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-btn-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // ç”Ÿæˆé¦¬åŒ¹æŒ‰éˆ•
        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `horse-slot-${i}`;
            div.innerHTML = `<div><b style="color:var(--gold)">${h.trait}</b></div><div style="font-size:24px; transform:scaleX(-1)">ğŸ</div>`;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function login(n) {
        myName = n;
        localStorage.setItem('my_race_name', n);
        db.ref(`users/${n}`).set(true);
    }

    function backToLogin() {
        db.ref(`users/${myName}`).remove();
        db.ref(`assignments/${myName}`).remove();
        myName = "";
        localStorage.removeItem('my_race_name');
        document.getElementById('screen-setup').style.display = 'none';
        document.getElementById('screen-login').style.display = 'block';
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-btn-${n}`);
                btn.className = `name-btn ${users[n] ? 'taken' : ''}`;
            });
            if (myName && users[myName]) {
                document.getElementById('screen-login').style.display = 'none';
                document.getElementById('screen-setup').style.display = 'block';
                document.getElementById('display-my-name').innerText = myName;
            }
        });

        db.ref('assignments').on('value', snap => {
            const data = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`horse-slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const label = slot.querySelector('.occupied-name'); if(label) label.remove();
                
                const owner = Object.keys(data).find(k => data[k] === i);
                if (owner) {
                    if (owner === myName) slot.classList.add('my-pick');
                    else {
                        slot.classList.add('occupied');
                        const l = document.createElement('div'); l.className='occupied-name'; l.innerText=owner;
                        slot.appendChild(l);
                    }
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing') startRace(state);
            else if (!state) location.reload();
        });
    }

    function startRace(state) {
        document.getElementById('screen-setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        
        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = '';
        const players = Object.keys(state.participants).map(name => ({
            name, horse: horseLibrary[state.participants[name]]
        }));

        const laneH = 100 / players.length;
        players.forEach((p, i) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneH}%`;
            lane.innerHTML = `<div class="horse-container" id="horse-ent-${i}">
                <div class="horse-icon">ğŸ</div>
                <div style="font-size:10px;">${p.name}</div>
            </div>`;
            lanesBox.appendChild(lane);
        });

        const raceDuration = 30000; // 30ç§’
        const trackW = document.getElementById('track').offsetWidth - 80;

        const timer = setInterval(() => {
            const elapsed = Date.now() - state.startTime;
            const progress = elapsed / raceDuration; // 0.0 ~ 1.0

            if (progress >= 0) {
                players.forEach((p, i) => {
                    // ä½¿ç”¨ç¢ºå®šæ€§æ¼”ç®—æ³•æ¨ç®—ä½ç½® (èˆ‡ FPS ç„¡é—œ)
                    const seedShift = state.seed * (i + 1);
                    const wave = Math.sin(progress * 10 + seedShift) * 0.05; // éš¨æ©ŸæŠ–å‹•
                    const boost = (progress > 0.8 && p.horse.id === 7) ? (progress - 0.8) * 2 : 0; // æˆªç¨¿è¡åˆº
                    
                    const moveProgress = Math.min(1.1, (progress * p.horse.spd) + wave + boost);
                    const el = document.getElementById(`horse-ent-${i}`);
                    el.style.left = (moveProgress * trackW) + 'px';
                });
            }

            if (progress >= 1.1) {
                clearInterval(timer);
                showFinalResults(players, state.seed);
            }
        }, 30);
    }

    function showFinalResults(players, seed) {
        const results = players.map((p, i) => {
            const score = p.horse.spd + (p.horse.id === 7 ? 0.3 : 0) + (Math.sin(seed * (i+1)) * 0.2);
            return { name: p.name, score };
        }).sort((a,b) => b.score - a.score);

        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';
        results.forEach((r, i) => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:red; font-weight:bold;">${i === 0 ? '$2500' : (i < 5 ? '$1000' : '$100')}</span>
            </div>`;
        });
        document.getElementById('leaderboard').style.display = 'block';
    }

    function triggerStart() {
        db.ref('assignments').once('value', snap => {
            if(!snap.exists()) return alert("æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + 2000,
                seed: Math.random(),
                participants: snap.val()
            });
        });
    }

    function resetData() {
        if(confirm("é‡ç½®æ•¸æ“šï¼Ÿ")) db.ref().set(null);
    }

    init();
</script>
</body>
</html><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - çµ•å°åŒæ­¥ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        body { font-family: 'PingFang TC', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç®¡ç†è€…å·¥å…· */
        #admin-toolbar { position: fixed; top: 10px; right: 10px; display: none; z-index: 9999; }
        .admin-btn { padding: 5px 10px; background: rgba(0,0,0,0.6); color: white; border: 1px solid #666; border-radius: 4px; font-size: 12px; cursor: pointer; }

        /* ä½¿ç”¨è€…ç‹€æ…‹æ¬„ */
        .user-status-bar { width: 100%; padding: 10px; background: #1e1e1e; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .btn-back { padding: 4px 12px; background: #444; border: none; color: white; border-radius: 4px; cursor: pointer; }

        /* é¸äºº/é¸é¦¬ç•«é¢ */
        .overlay-screen { background: #121212; position: fixed; inset: 0; padding: 20px; z-index: 100; overflow-y: auto; text-align: center; }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .name-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; font-weight: bold; font-size: 16px; }
        .name-btn.taken { opacity: 0.2; pointer-events: none; }
        
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-top: 15px; }
        .horse-slot { background: #252525; padding: 10px; border-radius: 10px; border: 2px solid #333; position: relative; text-align: left; }
        .horse-slot.occupied { opacity: 0.3; pointer-events: none; }
        .horse-slot.my-pick { border-color: var(--success); background: #1a2e1a; }
        .occupied-name { position: absolute; top: 5px; right: 5px; font-size: 10px; background: var(--primary); padding: 2px 5px; border-radius: 3px; }

        /* è³½é“ */
        .track-container { position: relative; width: 100%; flex-grow: 1; background: var(--track-bg); display: none; overflow: hidden; }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); opacity: 0.2; }
        .lane { position: relative; width: 100%; border-bottom: 1px dashed rgba(255,255,255,0.05); }
        .horse-container { position: absolute; left: 0; top: 50%; transform: translateY(-50%); display: flex; align-items: center; will-change: left; }
        .horse-icon { font-size: 28px; transform: scaleX(-1); }
        
        #start-btn { position: fixed; bottom: 30px; padding: 15px 60px; font-size: 20px; background: var(--primary); color: white; border: none; border-radius: 30px; font-weight: bold; display: none; z-index: 50; }
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: white; color: black; border-radius: 15px; padding: 20px; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="admin-toolbar">
        <button class="admin-btn" onclick="resetData()">é‡ç½®éŠæˆ²</button>
    </div>

    <div id="screen-login" class="overlay-screen">
        <h2 style="color:var(--gold)">WHO ARE YOU?</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="screen-setup" class="overlay-screen" style="display:none;">
        <div class="user-status-bar">
            <span>ç•¶å‰èº«åˆ†ï¼š<b id="display-my-name" style="color:var(--gold)"></b></span>
            <button class="btn-back" onclick="backToLogin()">è¿”å›é‡é¸</button>
        </div>
        <h3 style="margin: 15px 0;">è«‹æŒ‘é¸æˆ°é¦¬</h3>
        <div class="horse-select-grid" id="select-grid"></div>
        <button id="start-btn" onclick="triggerStart()">ğŸ é–‹å§‹æ¯”è³½</button>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0;">ğŸ† æ¯”è³½çµæœ</h2>
        <div id="leaderboard-list" style="margin: 15px 0;"></div>
        <button onclick="location.reload()" style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:8px;">è¿”å›</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
        authDomain: "aiot-d53dc.firebaseapp.com",
        databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
        projectId: "aiot-d53dc",
        storageBucket: "aiot-d53dc.firebasestorage.app",
        messagingSenderId: "1021331253049",
        appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
        measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 0.8, sta: 1.2 },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 0.7, sta: 0.9 },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 1.2, sta: 0.4 },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", spd: 0.9, sta: 0.8 },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’", spd: 1.0, sta: 0.7 },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", spd: 0.6, sta: 1.5 },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", spd: 0.85, sta: 1.1 },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", spd: 0.5, sta: 1.0 },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", spd: 1.1, sta: 0.6 },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", spd: 0.9, sta: 0.9 }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('my_race_name') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    function init() {
        if (isAdmin) {
            document.getElementById('admin-toolbar').style.display = 'block';
            document.getElementById('start-btn').style.display = 'block';
        }
        
        // ç”Ÿæˆå§“åæŒ‰éˆ•
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-btn-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // ç”Ÿæˆé¦¬åŒ¹æŒ‰éˆ•
        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `horse-slot-${i}`;
            div.innerHTML = `<div><b style="color:var(--gold)">${h.trait}</b></div><div style="font-size:24px; transform:scaleX(-1)">ğŸ</div>`;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function login(n) {
        myName = n;
        localStorage.setItem('my_race_name', n);
        db.ref(`users/${n}`).set(true);
    }

    function backToLogin() {
        db.ref(`users/${myName}`).remove();
        db.ref(`assignments/${myName}`).remove();
        myName = "";
        localStorage.removeItem('my_race_name');
        document.getElementById('screen-setup').style.display = 'none';
        document.getElementById('screen-login').style.display = 'block';
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-btn-${n}`);
                btn.className = `name-btn ${users[n] ? 'taken' : ''}`;
            });
            if (myName && users[myName]) {
                document.getElementById('screen-login').style.display = 'none';
                document.getElementById('screen-setup').style.display = 'block';
                document.getElementById('display-my-name').innerText = myName;
            }
        });

        db.ref('assignments').on('value', snap => {
            const data = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`horse-slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const label = slot.querySelector('.occupied-name'); if(label) label.remove();
                
                const owner = Object.keys(data).find(k => data[k] === i);
                if (owner) {
                    if (owner === myName) slot.classList.add('my-pick');
                    else {
                        slot.classList.add('occupied');
                        const l = document.createElement('div'); l.className='occupied-name'; l.innerText=owner;
                        slot.appendChild(l);
                    }
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing') startRace(state);
            else if (!state) location.reload();
        });
    }

    function startRace(state) {
        document.getElementById('screen-setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        
        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = '';
        const players = Object.keys(state.participants).map(name => ({
            name, horse: horseLibrary[state.participants[name]]
        }));

        const laneH = 100 / players.length;
        players.forEach((p, i) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneH}%`;
            lane.innerHTML = `<div class="horse-container" id="horse-ent-${i}">
                <div class="horse-icon">ğŸ</div>
                <div style="font-size:10px;">${p.name}</div>
            </div>`;
            lanesBox.appendChild(lane);
        });

        const raceDuration = 30000; // 30ç§’
        const trackW = document.getElementById('track').offsetWidth - 80;

        const timer = setInterval(() => {
            const elapsed = Date.now() - state.startTime;
            const progress = elapsed / raceDuration; // 0.0 ~ 1.0

            if (progress >= 0) {
                players.forEach((p, i) => {
                    // ä½¿ç”¨ç¢ºå®šæ€§æ¼”ç®—æ³•æ¨ç®—ä½ç½® (èˆ‡ FPS ç„¡é—œ)
                    const seedShift = state.seed * (i + 1);
                    const wave = Math.sin(progress * 10 + seedShift) * 0.05; // éš¨æ©ŸæŠ–å‹•
                    const boost = (progress > 0.8 && p.horse.id === 7) ? (progress - 0.8) * 2 : 0; // æˆªç¨¿è¡åˆº
                    
                    const moveProgress = Math.min(1.1, (progress * p.horse.spd) + wave + boost);
                    const el = document.getElementById(`horse-ent-${i}`);
                    el.style.left = (moveProgress * trackW) + 'px';
                });
            }

            if (progress >= 1.1) {
                clearInterval(timer);
                showFinalResults(players, state.seed);
            }
        }, 30);
    }

    function showFinalResults(players, seed) {
        const results = players.map((p, i) => {
            const score = p.horse.spd + (p.horse.id === 7 ? 0.3 : 0) + (Math.sin(seed * (i+1)) * 0.2);
            return { name: p.name, score };
        }).sort((a,b) => b.score - a.score);

        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';
        results.forEach((r, i) => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:red; font-weight:bold;">${i === 0 ? '$2500' : (i < 5 ? '$1000' : '$100')}</span>
            </div>`;
        });
        document.getElementById('leaderboard').style.display = 'block';
    }

    function triggerStart() {
        db.ref('assignments').once('value', snap => {
            if(!snap.exists()) return alert("æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({
                status: 'racing',
                startTime: Date.now() + 2000,
                seed: Math.random(),
                participants: snap.val()
            });
        });
    }

    function resetData() {
        if(confirm("é‡ç½®æ•¸æ“šï¼Ÿ")) db.ref().set(null);
    }

    init();
</script>
</body>
</html>
