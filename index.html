<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - çé‡‘é ’çå„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #2c3e50; 
            --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; 
            --recover: #00bcd4; --sprint: #ff5722; 
        }

        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: #121212; color: white; margin: 0; padding: 0; 
            height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden; touch-action: manipulation;
        }

        /* ç®¡ç†å“¡é¢æ¿ */
        #admin-panel {
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
            display: none; flex-direction: column; gap: 10px;
        }
        .admin-btn {
            padding: 12px 20px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* é¸äººç•«é¢å„ªåŒ– */
        #user-login { 
            background: rgba(30, 30, 30, 0.95); padding: 20px; border-radius: 20px; 
            text-align: center; z-index: 200; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 85%; max-width: 400px; 
            border: 2px solid var(--gold); box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .name-btn { 
            padding: 15px 10px; background: #333; border: 1px solid #555; 
            color: white; border-radius: 12px; font-size: 16px; font-weight: bold;
        }
        .name-btn.taken { opacity: 0.3; pointer-events: none; }
        .name-btn.me { background: var(--success); border-color: white; box-shadow: 0 0 10px var(--success); }

        /* é¸é¦¬ç•«é¢å„ªåŒ– (æ‰‹æ©Ÿæ²å‹•) */
        .setup-area { 
            flex-grow: 1; padding: 15px; width: 100%; box-sizing: border-box;
            overflow-y: auto; display: none; -webkit-overflow-scrolling: touch;
        }
        .horse-select-grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding-bottom: 80px; }
        .horse-slot { 
            background: linear-gradient(145deg, #252525, #1a1a1a); padding: 15px; 
            border-radius: 15px; border: 2px solid #333; position: relative; 
        }
        .horse-slot.my-pick { border-color: var(--success); background: rgba(76, 175, 80, 0.1); }
        .horse-slot.occupied { opacity: 0.4; filter: grayscale(0.8); }

        /* è³½é“å€å„ªåŒ– */
        .track-container { 
            position: relative; width: 100vw; flex-grow: 1; 
            background: var(--track-bg); display: none; overflow: hidden;
        }
        .lane { 
            position: relative; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; box-sizing: border-box;
        }
        .finish-line { 
            position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); 
            border-left: 2px solid var(--gold); z-index: 1; 
        }

        .horse-container { 
            position: absolute; left: 0; display: flex; align-items: center; 
            width: 100px; z-index: 10; will-change: left;
        }
        .horse-icon { font-size: 28px; transform: scaleX(-1); }
        .horse-label { font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px; }
        
        /* ç‹€æ…‹æ°£æ³¡åŒæ­¥æ„Ÿ */
        .status-bubble { 
            position: absolute; top: -30px; left: 0; font-size: 10px; padding: 2px 8px; 
            border-radius: 10px; display: none; white-space: nowrap; z-index: 100;
        }

        /* çµç®—ç•«é¢ */
        #leaderboard { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .leaderboard-content {
            width: 85%; background: white; color: black; border-radius: 20px;
            padding: 20px; max-height: 80vh; overflow-y: auto;
        }

        /* å…¶ä»–å…ƒä»¶ */
        #start-btn { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 15px 40px; font-size: 20px; background: var(--primary); 
            color: white; border: none; border-radius: 50px; display: none; z-index: 500;
        }
    </style>
</head>
<body>

    <audio id="bg-music" loop src="https://actions.google.com/sounds/v1/sports/crowd_cheer.ogg"></audio>
    <audio id="race-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>

    <h2 id="main-title" style="margin: 10px; text-align: center; color: var(--gold); font-size: 18px;">ğŸ’¼ 2026 AIOT å°¾ç‰™è³½é¦¬ - é¦¬å¹´è¡Œå¤§é‹</h2>

    <div id="user-login">
        <h2 style="color: var(--gold); margin: 0 0 10px 0;">ä½ æ˜¯èª°ï¼Ÿ</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <h3 id="picker-title" style="text-align: center; color: #fff;">è«‹æŒ‘é¸ä½ çš„æˆ°é¦¬</h3>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; position: relative;"></div>
    </div>

    <div id="admin-panel">
        <button id="start-btn-admin" class="admin-btn" style="background: var(--success); color: white;">ğŸ å¼·åˆ¶é–‹è³½ï¼</button>
        <button onclick="resetData()" class="admin-btn" style="background: var(--danger); color: white;">ğŸ”„ é‡ç½®å…¨å ´</button>
    </div>

    <div id="leaderboard">
        <div class="leaderboard-content">
            <h2 style="text-align:center; color: var(--primary); margin: 0 0 15px 0;">ğŸ† FINAL RANK ğŸ†</h2>
            <div id="leaderboard-list"></div>
            <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px; background: #333; color: white; border-radius: 10px;">é—œé–‰è¦–çª—</button>
        </div>
    </div>

<script>
    // --- Firebase é…ç½® (ä½¿ç”¨ä½ çš„é…ç½®) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·åœ¨ä¸»ç®¡è¦–ç·šå¤–ç·©æ­¥å‰é€²ï¼Œé«”åŠ›æ¢æ·±ä¸å¯æ¸¬ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "å¹³æ™‚ç¯€èƒ½æ¨¡å¼ï¼Œä¸€æ—¦å¤•é™½è¥¿ä¸‹ä¾¿é–‹å•Ÿè¶…é »æ¨¡å¼ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "èµ·æ­¥ç¬é–“å³å·”å³°ï¼Œä½†éœ€æ³¨æ„å¥åº·è­¦è¨Šã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç¯€å¥æ„Ÿæ¥µå¼·ï¼Œèƒ½ä»¥ç©©å®šçš„èªé€Ÿå£“åˆ¶å…¨å ´ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "ä¾è³´èˆˆå¥®åŠ‘ï¼Œé€Ÿåº¦å–æ±ºæ–¼æ—©ä¸Šçš„æ‹¿éµæ¿ƒåº¦ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "æ“æœ‰ç¥ç´šé–ƒé¿ï¼Œä»»ä½•éšœç¤™èˆ‡è²¬ä»»éƒ½ç¢°ä¸åˆ°ç‰ ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "æ²’äººæ³¨æ„åˆ°ç‰ å·²æ‚„æ‚„è·‘åˆ°æœ€å‰é¢ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "åœ¨æœ€å¾Œä¸€ç§’å‰ï¼Œä½ æ°¸é ä¸çŸ¥é“ç‰ æœƒçˆ†ç™¼ä»€éº¼ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "ç”¨æ°£å‹¢é©…å‹•å››è‚¢ï¼Œé€Ÿåº¦å¿«åˆ°è®“äººç„¡æ³•åé§ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "ä¸æ±‚æœ€å¿«ï¼Œä½†çµ•å°æ´»å¾—æ¯”ä»»ä½•é¦¬éƒ½ä¹…ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    const colors = ["#FF5252", "#FFD700", "#E040FB", "#00E676", "#2979FF", "#FF9100", "#40C4FF", "#FF1744", "#F4FF81", "#B2FF59"];

    let myName = localStorage.getItem('my_race_name') || "";
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === '1';
    let raceStarted = false;
    let serverStartTime = 0;

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'flex';
        
        // ç”Ÿæˆåå­—æŒ‰éˆ•
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn';
            btn.id = `name-${n}`;
            btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // ç”Ÿæˆé¦¬åŒ¹å¡ç‰‡
        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot';
            div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <b style="color:var(--gold); font-size:18px;">${h.trait}</b>
                    <span style="font-size:10px; background:var(--primary); padding:2px 5px; border-radius:4px;">STAFF-${i+1}</span>
                </div>
                <div style="font-size:32px; margin:10px 0; transform: scaleX(-1);">ğŸ</div>
                <div style="font-size:11px; color:#aaa; margin-bottom:10px;">${h.desc}</div>
                <div class="stat-group">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:10px;">
                        <div>é€Ÿåº¦: ${h.stats.spd}</div><div>é«”åŠ›: ${h.stats.sta}</div>
                        <div>çˆ†ç™¼: ${h.stats.burst}</div><div>å¹¸é‹: ${h.stats.lck}</div>
                    </div>
                </div>
            `;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });

        listenFirebase();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) {
                    btn.classList.add('taken');
                    if (n === myName) {
                        btn.classList.add('me');
                        document.getElementById('user-login').style.display = 'none';
                        document.getElementById('setup').style.display = 'block';
                        document.getElementById('bg-music').play().catch(()=>{});
                    }
                } else {
                    btn.classList.remove('taken', 'me');
                }
            });
        });

        db.ref('assignments').on('value', snap => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                slot.className = 'horse-slot';
                if (owner) {
                    if (owner === myName) slot.classList.add('my-pick');
                    else slot.classList.add('occupied');
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) {
                serverStartTime = state.startTime;
                startTheGame(state.seed, state.participants);
            } else if (!state || state.status === 'idle') {
                if(raceStarted) location.reload(); 
            }
        });
    }

    function login(n) {
        myName = n;
        localStorage.setItem('my_race_name', n);
        db.ref(`users/${n}`).set(true);
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`assignments/${myName}`).set(idx);
    }

    function resetData() {
        if(!confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ‰€æœ‰äººå°‡é‡æ–°ç™»å…¥ï¼")) return;
        db.ref().set({ gameState: { status: 'idle' } });
    }

    document.getElementById('start-btn-admin').onclick = function() {
        db.ref('assignments').once('value', snap => {
            const participants = snap.val() || {};
            if (Object.keys(participants).length === 0) return alert("é‚„æ²’äººé¸é¦¬ï¼");
            db.ref('gameState').set({
                status: 'racing',
                seed: Math.random(),
                startTime: Date.now() + 2000, // 2ç§’å¾Œæº–æ™‚é–‹è³½
                participants: participants
            });
        });
    };

    function startTheGame(seed, participants) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('bg-music').pause();
        document.getElementById('race-music').play().catch(()=>{});

        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = "";
        
        const finalParticipants = Object.keys(participants).map((name, idx) => ({
            name, horseData: horseLibrary[participants[name]], color: colors[idx % colors.length]
        }));

        const laneHeight = 100 / Math.max(finalParticipants.length, 5);
        finalParticipants.forEach((item, idx) => {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `
                <div class="horse-container" id="horse-container-${idx}">
                    <div class="status-bubble" id="status-${idx}"></div>
                    <div class="horse-icon" style="color:${item.color}">ğŸ</div>
                    <div style="display:flex; flex-direction:column;">
                        <span class="horse-label">${item.name}</span>
                        <div style="width:40px; height:4px; background:#000; border-radius:2px;">
                            <div id="stamina-${idx}" style="width:100%; height:100%; background:var(--success); transition:0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            lanesBox.appendChild(lane);
        });

        runSynchronizedEngine(seed, finalParticipants);
    }

    // --- åŒæ­¥æ ¸å¿ƒå¼•æ“ ---
    function runSynchronizedEngine(seed, list) {
        const trackWidth = document.getElementById('track').offsetWidth;
        const finishLineX = trackWidth - 110;

        const horses = list.map(item => ({
            ...item, 
            pos: 10, 
            finished: false,
            rank: 0
        }));

        let finishedCount = 0;

        function update() {
            const now = Date.now();
            const elapsed = (now - serverStartTime) / 1000; // ç§’

            if (elapsed < 0) {
                requestAnimationFrame(update);
                return;
            }

            let allFinished = true;
            horses.forEach((h, i) => {
                if (h.finished) return;
                allFinished = false;

                // ä½¿ç”¨ Seed + ç´¢å¼• + æ™‚é–“ é€²è¡Œå®Œå…¨ç¢ºå®šçš„éš¨æ©Ÿé‹ç®—
                const deterministicSeed = Math.sin(seed + i) * 10000;
                const pseudoRandom = (t) => (Math.abs(Math.sin(deterministicSeed + t)) * 100) % 1;

                // åŸºç¤é€Ÿåº¦èˆ‡é«”åŠ›æ¶ˆè€— (èˆ‡æ™‚é–“æ›é‰¤)
                let speed = (h.horseData.stats.spd * 0.5) + (pseudoRandom(Math.floor(elapsed)) * 15);
                
                // æ¨¡æ“¬äº‹ä»¶åŒæ­¥
                const eventTick = Math.floor(elapsed / 3);
                const eventRoll = pseudoRandom(eventTick);
                const bubble = document.getElementById(`status-${i}`);

                if (eventRoll > 0.9) {
                    speed *= 1.5;
                    bubble.innerText = "âš¡ è¡åˆºï¼";
                    bubble.style.display = "block";
                    bubble.style.background = "var(--sprint)";
                } else if (eventRoll < 0.1) {
                    speed *= 0.3;
                    bubble.innerText = "â›¸ï¸ æ»‘å€’ï¼";
                    bubble.style.display = "block";
                    bubble.style.background = "var(--danger)";
                } else {
                    bubble.style.display = "none";
                }

                // è¨ˆç®—ç•¶å‰ä½ç½®
                h.pos = 10 + (elapsed * speed);
                
                const el = document.getElementById(`horse-container-${i}`);
                el.style.left = Math.min(h.pos, finishLineX + 50) + "px";

                // æŠ–å‹•æ•ˆæœ
                el.style.transform = `translateY(${Math.sin(elapsed * 10) * 2}px)`;

                if (h.pos >= finishLineX) {
                    h.finished = true;
                    h.rank = ++finishedCount;
                    h.finishTime = elapsed;
                }
            });

            if (finishedCount < horses.length) {
                requestAnimationFrame(update);
            } else {
                setTimeout(() => showLeaderboard(horses), 1000);
            }
        }

        requestAnimationFrame(update);
    }

    function showLeaderboard(results) {
        document.getElementById('leaderboard').style.display = 'flex';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        
        const sorted = results.sort((a, b) => a.rank - b.rank);
        sorted.forEach(h => {
            const div = document.createElement('div');
            div.style.cssText = "padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:bold;";
            
            let prize = "-";
            if (h.rank === 1) prize = "ğŸ¥‡ $2500";
            else if (h.rank <= 5) prize = `ğŸ¥ˆ $1000ç¦®åˆ¸`;
            else prize = `ğŸ¥‰ åƒåŠ ç`;

            div.innerHTML = `
                <span>#${h.rank} ${h.name}</span>
                <span style="color:var(--primary)">${prize}</span>
            `;
            list.appendChild(div);
        });
    }

    init();
</script>
</body>
</html>
