<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å°¾ç‰™è³½é¦¬å¤§è³½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        .horse-track { height: 60px; border-bottom: 1px dashed #ccc; position: relative; }
        .horse-emoji { font-size: 30px; position: absolute; transition: left 0.5s linear; bottom: 5px; }
        .event-popup { animation: fadeUp 2s forwards; position: absolute; top: -20px; color: red; font-weight: bold; font-size: 12px; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }
        .selected { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
    </style>
</head>
<body class="bg-slate-100 font-sans pb-10">

    <div id="app" class="max-w-md mx-auto p-4">
        <header class="text-center my-6">
            <h1 class="text-3xl font-black text-indigo-600">ğŸ å°¾ç‰™é£†é¦¬å¤§è³½</h1>
            <p class="text-gray-500 text-sm">å…ˆé¸å…ˆè´ï¼Œé‹æ°£ä¹Ÿæ˜¯å¯¦åŠ›çš„ä¸€ç¨®</p>
        </header>

        <section id="step-user" class="bg-white p-6 rounded-2xl shadow-lg mb-4">
            <h2 class="text-xl font-bold mb-4">ä½ æ˜¯èª°ï¼Ÿ</h2>
            <div id="user-list" class="grid grid-cols-2 gap-3"></div>
        </section>

        <section id="step-horse" class="bg-white p-6 rounded-2xl shadow-lg mb-4 hidden">
            <h2 class="text-xl font-bold mb-2">æŒ‘é¸ä½ çš„æˆ°é¦¬</h2>
            <div id="horse-selection" class="space-y-3"></div>
        </section>

        <section id="step-race" class="bg-white p-4 rounded-2xl shadow-xl mb-4 hidden">
            <div id="race-status" class="text-center font-bold text-orange-500 mb-4 text-xl italic">ç­‰å¾…èŠå®¶é–‹è³½...</div>
            <div id="track-container" class="space-y-1"></div>
        </section>

        <section id="step-result" class="bg-yellow-400 p-6 rounded-2xl shadow-lg mb-4 hidden">
            <h2 class="text-2xl font-black text-center mb-4">ğŸ† å¾—çåå–®</h2>
            <div id="rank-list" class="space-y-2"></div>
        </section>

        <section id="admin-panel" class="bg-black text-white p-6 rounded-2xl shadow-lg mt-10 hidden">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ç®¡ç†è€… Dashboard</h2>
            <div id="admin-monitor" class="text-sm mb-4"></div>
            <div class="flex gap-2">
                <button onclick="startGame()" class="bg-green-600 px-4 py-2 rounded font-bold flex-1">é–‹å§‹æ¯”è³½</button>
                <button onclick="resetGame()" class="bg-red-600 px-4 py-2 rounded font-bold flex-1">é‡ç½®éŠæˆ²</button>
            </div>
        </section>
    </div>

    <audio id="bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>

    <script>
        // Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
            authDomain: "aiot-d53dc.firebaseapp.com",
            databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
            projectId: "aiot-d53dc",
            storageBucket: "aiot-d53dc.firebasestorage.app",
            messagingSenderId: "1021331253049",
            appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
            measurementId: "G-9YDKS70ZE7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // åˆå§‹è³‡æ–™
        const players = ["Julia", "Molly", "Juli", "è±ªå“¥", "Don", "Gimme", "å‰å¿—", "Erick", "Jason", "KRIS"];
        const horseData = [
            { id: 0, name: "çˆ†æ±—è‚¥å®…", emoji: "ğŸ·", desc: "é«”åŠ›æ¥µå·®ä½†è¡åˆºæ™‚æœ‰ç‚¸é›å‘³", spd: 5, sta: 2 },
            { id: 1, name: "å„ªé›…è²´å©¦", emoji: "ğŸ©", desc: "èµ°å¤ªå¿«æœƒæµæ±—ï¼Œå¿ƒæƒ…å¥½æ‰è·‘", spd: 4, sta: 5 },
            { id: 2, name: "éæœŸé®®ä¹³", emoji: "ğŸ¥›", desc: "éš¨æ™‚æœƒè…¹ç€‰å°è‡´çŸ­æš«åœç•™", spd: 6, sta: 3 },
            { id: 3, name: "å°ˆæ¡ˆæ®ºæ‰‹", emoji: "ğŸ”ª", desc: "é€Ÿåº¦æ¥µå¿«ä½†å®¹æ˜“è¿·å¤±æ–¹å‘", spd: 8, sta: 2 },
            { id: 4, name: "æ‘¸é­šå¤§å¸«", emoji: "ğŸŸ", desc: "æ“…é•·åœ¨åŸåœ°å‡è£å¾ˆåŠªåŠ›", spd: 3, sta: 8 },
            { id: 5, name: "å’–å•¡ä¸­æ¯’", emoji: "â˜•", desc: "æ‰‹ç‹‚æŠ–ï¼Œè·¯å¾‘æ¥µå…¶è©­ç•°", spd: 7, sta: 4 },
            { id: 6, name: "è–ªæ°´å°å·", emoji: "ğŸ¦", desc: "æœƒå·è·‘ä½†æ²’è¢«ç™¼ç¾å°±ä¸ç®—", spd: 5, sta: 5 },
            { id: 7, name: "ç†±æƒ…PM", emoji: "ğŸ”¥", desc: "å—“é–€å¤§ï¼Œåš‡è·‘å‘¨åœçš„é¦¬", spd: 6, sta: 6 },
            { id: 8, name: "Debugè²“", emoji: "ğŸ±", desc: "æ²’äº‹æœƒåœä¸‹ä¾†èˆ”æ¯›", spd: 4, sta: 7 },
            { id: 9, name: "é–ƒé›»ä¿ ", emoji: "âš¡", desc: "çœ‹èµ·ä¾†å¾ˆå¿«å…¶å¯¦æ˜¯ç‰¹æ•ˆ", spd: 9, sta: 1 }
        ];
        const prizes = ["$2500 ç¾é‡‘", "æ–°å…‰1000", "500ç¦®å·", "400ç¦®å·", "300ç¦®å·", "200ç¦®å·", "100ç¦®å·", "æ„Ÿè¬åƒèˆ‡", "æ„Ÿè¬åƒèˆ‡", "ä¸‹æ¬¡åŠªåŠ›"];

        let myName = "";
        let myHorseId = null;

        // åˆå§‹åŒ– UI
        function init() {
            const userList = document.getElementById('user-list');
            players.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "p-3 bg-indigo-50 rounded-lg border border-indigo-200 hover:bg-indigo-500 hover:text-white transition font-bold";
                btn.innerText = p;
                btn.onclick = () => selectUser(p);
                userList.appendChild(btn);
            });

            // ç®¡ç†è€…æ¨¡å¼
            if(window.location.hash === '#admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
            }

            // ç›£è½ Firebase å…¨åŸŸç‹€æ…‹
            db.ref('gameState').on('value', snapshot => {
                const state = snapshot.val();
                if(!state) return;
                
                renderHorses(state.selections || {});
                updateAdminMonitor(state.selections || {});
                
                if(state.status === 'racing') startRaceAnimation(state.seed);
                if(state.status === 'waiting') resetUI();
            });
        }

        function selectUser(name) {
            myName = name;
            document.getElementById('step-user').classList.add('hidden');
            document.getElementById('step-horse').classList.remove('hidden');
            renderHorseSelection();
        }

        function renderHorseSelection() {
            const container = document.getElementById('horse-selection');
            container.innerHTML = "";
            db.ref('gameState/selections').once('value', snapshot => {
                const selections = snapshot.val() || {};
                const selectedHorseIds = Object.values(selections).map(s => s.horseId);

                horseData.forEach(h => {
                    const isTaken = selectedHorseIds.includes(h.id);
                    const owner = Object.keys(selections).find(key => selections[key].horseId === h.id);
                    const div = document.createElement('div');
                    div.className = `p-3 border-2 rounded-xl flex justify-between items-center cursor-pointer ${isTaken ? 'selected bg-gray-100' : 'border-indigo-500'}`;
                    div.innerHTML = `
                        <div>
                            <span class="text-2xl">${h.emoji}</span>
                            <span class="font-bold ml-2">${h.name}</span>
                            <p class="text-xs text-gray-500">${h.desc}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs block">${isTaken ? 'å·²è¢« '+owner+' é¸èµ°' : 'é€Ÿ:'+h.spd+' é«”:'+h.sta}</span>
                        </div>
                    `;
                    if(!isTaken) div.onclick = () => pickHorse(h.id);
                    container.appendChild(div);
                });
            });
        }

        function pickHorse(id) {
            db.ref(`gameState/selections/${myName}`).set({ horseId: id });
            myHorseId = id;
            document.getElementById('step-horse').classList.add('hidden');
            document.getElementById('step-race').classList.remove('hidden');
            document.getElementById('bgm').play();
        }

        function renderHorses(selections) {
            const container = document.getElementById('track-container');
            container.innerHTML = "";
            Object.entries(selections).forEach(([name, data]) => {
                const horse = horseData[data.horseId];
                const track = document.createElement('div');
                track.className = "horse-track";
                track.innerHTML = `
                    <div class="absolute left-0 text-[10px] text-gray-400 font-bold">${name}</div>
                    <div id="horse-runner-${data.horseId}" class="horse-emoji" style="left: 0%">
                        ${horse.emoji}
                        <div class="event-msg"></div>
                    </div>
                `;
                container.appendChild(track);
            });
        }

        // --- è³½é¦¬é‚è¼¯ ---
        function startRaceAnimation(seed) {
            document.getElementById('race-status').innerText = "ğŸ æ¯”è³½é–‹å§‹ï¼ï¼";
            const horsesOnTrack = document.querySelectorAll('[id^="horse-runner-"]');
            let finishedCount = 0;
            const rankings = [];

            horsesOnTrack.forEach(el => {
                const horseId = parseInt(el.id.replace('horse-runner-', ''));
                const stats = horseData[horseId];
                let position = 0;
                
                const interval = setInterval(() => {
                    if(position >= 90) {
                        clearInterval(interval);
                        finishedCount++;
                        rankings.push({id: horseId, name: players.find(p => p === players[horseId])}); // ç°¡åŒ–è™•ç†
                        if(finishedCount === horsesOnTrack.length) showFinalResults(rankings);
                        return;
                    }

                    // éš¨æ©Ÿäº‹ä»¶é‚è¼¯
                    const roll = Math.random();
                    let step = (stats.spd * 0.2);

                    if(roll < 0.05) { // çˆ†è‚
                        step = 0;
                        showEvent(el, "ğŸ˜« çˆ†è‚åœæ©Ÿ 5s");
                    } else if(roll > 0.95) { // è¡åˆº
                        step *= 3;
                        showEvent(el, "ğŸš€ å’–å•¡å› çˆ†ç™¼!");
                    } else if(roll > 0.90 && roll < 0.92) { // çœ‹åˆ°æ­£å¦¹
                        step = -2;
                        showEvent(el, "ğŸ˜ çœ‹åˆ°æ­£å¦¹åˆ†å¿ƒ");
                    }

                    position += step;
                    el.style.left = position + "%";
                }, 300);
            });
        }

        function showEvent(el, msg) {
            const msgEl = el.querySelector('.event-msg');
            msgEl.innerHTML = `<div class="event-popup">${msg}</div>`;
        }

        function showFinalResults(rankings) {
            document.getElementById('step-result').classList.remove('hidden');
            const list = document.getElementById('rank-list');
            list.innerHTML = "";
            // é€™è£¡å¯¦éš›æ‡‰æ ¹æ“šæŠµé”é †åºï¼Œæ­¤è™•å…ˆç¤ºæ„
            prizes.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = "flex justify-between bg-white/50 p-2 rounded";
                div.innerHTML = `<span>ç¬¬ ${i+1} å</span> <b>${p}</b>`;
                list.appendChild(div);
            });
        }

        // --- ç®¡ç†è€…åŠŸèƒ½ ---
        function updateAdminMonitor(selections) {
            const monitor = document.getElementById('admin-monitor');
            const count = Object.keys(selections).length;
            monitor.innerText = `ç›®å‰é¸é¦¬é€²åº¦: ${count} / 10 äºº`;
        }

        function startGame() {
            db.ref('gameState').update({ status: 'racing', seed: Math.random() });
        }

        function resetGame() {
            db.ref('gameState').set({ status: 'waiting', selections: {} });
            window.location.reload();
        }

        init();
    </script>
</body>
</html>
