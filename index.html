<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å°ˆæ¥­ç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; 
            --gold: #ffd700; 
            --track-bg: #1a1a1a; 
            --success: #4caf50; 
            --warning: #ffeb3b; 
            --danger: #ff5252; 
            --recover: #00bcd4; 
            --sprint: #ff5722;
            --card-bg: #2a2a2a;
        }
        
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: #121212; 
            color: white; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow: hidden; 
        }

        /* ç®¡ç†å“¡é¢æ¿ */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; background: rgba(211, 47, 47, 0.95); padding: 8px; text-align: center; z-index: 9999; display: none; border-bottom: 2px solid white; font-size: 14px; }
        .emergency-btn { background: white; color: var(--primary); border: none; padding: 4px 12px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        /* æ¨™é¡Œ */
        .header-title { margin: 15px 0 5px 0; color: var(--gold); letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 24px; text-align: center; }

        /* é¸äººç•«é¢ - æ‰‹æ©Ÿå„ªåŒ– */
        #user-login { background: #1e1e1e; padding: 20px; border-radius: 20px; text-align: center; z-index: 200; position: fixed; top: 50%; transform: translateY(-50%); width: 85%; max-width: 400px; border: 2px solid var(--gold); box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .name-btn { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .name-btn:hover { background: var(--gold); color: black; }
        .name-btn.taken { opacity: 0.2; pointer-events: none; text-decoration: line-through; }
        .name-btn.me { background: var(--success); border-color: white; box-shadow: 0 0 10px var(--success); }

        /* é¸é¦¬å€ - å¡ç‰‡é¢¨æ ¼èˆ‡éŸ¿æ‡‰å¼ */
        .setup-area { width: 100%; max-width: 1200px; flex-grow: 1; overflow-y: auto; padding: 10px 15px 40px 15px; box-sizing: border-box; display: none; }
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .horse-slot { 
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a); 
            padding: 15px; 
            border-radius: 15px; 
            border: 2px solid #3d3d3d; 
            cursor: pointer; 
            transition: 0.3s; 
            position: relative;
        }
        .horse-slot:hover { border-color: var(--gold); transform: translateY(-3px); }
        .horse-slot.occupied { opacity: 0.4; filter: grayscale(0.8); pointer-events: none; }
        .horse-slot.my-pick { border: 3px solid var(--success); background: #1b3a1b; box-shadow: 0 0 15px rgba(76, 175, 80, 0.4); }
        
        .horse-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .horse-no { background: var(--gold); color: black; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .horse-avatar { font-size: 40px; margin: 10px 0; display: block; text-align: center; filter: drop-shadow(0 0 5px rgba(255,215,0,0.3)); }
        .horse-name { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 5px; text-align: center; }
        .horse-desc { font-size: 13px; color: #bbb; line-height: 1.4; height: 36px; margin-bottom: 12px; text-align: center; font-style: italic; }
        
        /* èƒ½åŠ›å€¼æ¢ */
        .stat-group { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; }
        .stat-row { display: flex; align-items: center; margin-bottom: 4px; }
        .stat-label { font-size: 11px; width: 35px; color: #aaa; }
        .stat-bar { flex-grow: 1; height: 6px; background: #444; border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #ff9100); }
        
        .occupied-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: var(--primary); color: white; padding: 5px 15px; font-weight: bold; z-index: 10; border: 2px solid white; white-space: nowrap; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* è³½é“å€ */
        .track-container { position: relative; width: 98vw; flex-grow: 1; background: var(--track-bg); border: 2px solid #333; border-radius: 10px; display: none; margin-top: 5px; overflow: hidden; }
        .finish-line { position: absolute; right: 80px; top: 0; bottom: 0; width: 25px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 3px solid var(--gold); z-index: 1; }
        .lane { position: relative; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; }
        .horse-container { position: absolute; left: 10px; z-index: 10; display: flex; align-items: center; width: 120px; transition: left 0.1s linear; }
        .horse-icon { font-size: 28px; transform: scaleX(-1); margin-right: 5px; }
        .stamina-mini { width: 40px; height: 4px; background: #000; border-radius: 2px; margin-top: 2px; }
        .stamina-mini-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .status-bubble { position: absolute; top: -35px; left: 0; font-size: 11px; padding: 3px 8px; border-radius: 10px; display: none; z-index: 100; font-weight: bold; color: white; border: 1px solid white; white-space: nowrap; }

        /* æŒ‰éˆ•èˆ‡æ’è¡Œæ¦œ */
        #start-btn { padding: 15px 60px; font-size: 22px; background: linear-gradient(135deg, var(--primary), #8e0000); color: white; border: none; border-radius: 50px; cursor: pointer; margin: 15px; display: none; font-weight: bold; box-shadow: 0 5px 15px rgba(211,47,47,0.4); }
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 450px; background: white; color: #111; border-radius: 20px; padding: 20px; z-index: 1000; display: none; border: 6px solid var(--gold); box-shadow: 0 0 50px rgba(0,0,0,0.9); text-align: center; }
        .rank-row { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: bold; }
        .rank-top { background: #fffde7; }
        .prize-text { color: var(--primary); font-size: 16px; }

        @media (max-width: 600px) {
            .horse-select-grid { grid-template-columns: 1fr; }
            .header-title { font-size: 20px; }
        }
    </style>
</head>
<body>

    <div id="admin-panel">
        <span>ğŸ”§ ç®¡ç†å“¡æ¨¡å¼</span>
        <button class="emergency-btn" onclick="resetData()">å¼·åˆ¶é‡ç½®</button>
    </div>

    <h2 class="header-title">ğŸ 2026 AIOT é¦¬å¹´è¡Œå¤§é‹</h2>

    <div id="user-login">
        <h2 style="color: var(--gold); margin: 0 0 10px 0;">ä½ æ˜¯å“ªä½åŒä»ï¼Ÿ</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div style="text-align:center; margin-bottom: 15px;">
            <h3 style="margin:0; color:var(--gold);">ğŸ† æŒ‘é¸æ‚¨çš„æˆ°é¦¬ ğŸ†</h3>
            <small style="color:#aaa;">æ¯åŒ¹é¦¬éƒ½æœ‰ç¨ç‰¹çš„è·å ´æŠ€èƒ½</small>
        </div>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn">ğŸ é–‹è³½ï¼ (ç®¡ç†å“¡)</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; display: flex; flex-direction: column;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="color: var(--primary); margin: 0;">ğŸŠ é ’çæ™‚åˆ» ğŸŠ</h2>
        <div id="leaderboard-list" style="margin-top: 15px;"></div>
        <button onclick="resetData()" style="width:100%; padding:12px; margin-top:15px; background: #333; color: white; border:none; border-radius: 10px; cursor:pointer; font-weight: bold;">è¿”å›é‡ä¾†</button>
    </div>

    <audio id="bgm" loop src="https://actions.google.com/config/promo/sdk/v1/sample_audio/gameloop.m4a"></audio>
    <audio id="snd-start" src="https://www.soundjay.com/misc/sounds/starting-pistol-1.mp3"></audio>
    <audio id="snd-win" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>

<script>
    // --- 1. Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. æ•¸æ“šåº« ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, bst: 40}, desc: "ã€Œåªè¦æˆ‘ä¸å°·å°¬ï¼Œå°·å°¬çš„å°±æ˜¯è€é—†ã€‚ã€æ“…é•·é•·æœŸæŠ—æˆ°ï¼Œæ°¸ä¸çˆ†è‚ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, bst: 95}, desc: "17:59 åˆ†æœƒè‡ªå‹•è§¸ç™¼ã€ŒZoneã€é ˜åŸŸï¼Œæœ€å¾Œè¡åˆºé€Ÿåº¦æå‡ã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, bst: 80}, desc: "æ‹¿è‘—ä¸‰æ¯å¤§å†°ç¾ï¼Œèµ·è·‘åƒå™´å°„æ©Ÿï¼Œä½†éš¨æ™‚æœƒå€’åœ°ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, bst: 60}, desc: "ç©©å®šè¼¸å‡ºä½†æ²’äººè½å¾—æ‡‚ä»–åœ¨è·‘ä»€éº¼ï¼Œå„é …æ•¸å€¼å¹³å‡ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, bst: 75}, desc: "è¡€æ¶²è£¡éƒ½æ˜¯é˜¿æ‹‰æ¯”å¡è±†ï¼Œæƒ…ç·’èµ·ä¼èˆ‡é€Ÿåº¦ä¸€æ¨£å¤§ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, bst: 30}, desc: "å„ªé›…åœ°èº²éæ‰€æœ‰æ„å¤–ï¼Œå› ç‚ºä»–æŠŠæ»‘å€’éƒ½ç”©çµ¦åˆ¥äººäº†ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, bst: 50}, desc: "å­˜åœ¨æ„Ÿæ¥µä½ï¼Œç•¶ä½ ç™¼ç¾ä»–åœ¨å‰é¢çš„æ™‚å€™ï¼Œä»–å·²ç¶“è·‘å¾ˆä¹…äº†ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, bst: 99}, desc: "ä¸åˆ°æœ€å¾Œä¸€åˆ»çµ•å°ä¸è·‘ï¼Œæœ€å¾Œä¸€ç§’é€£é«˜éµéƒ½è¿½ä¸ä¸Šã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, bst: 70}, desc: "ç”¨æ°£å‹¢åœ¨è·‘æ­¥ï¼Œæ•ˆç‡æ¥µé«˜ä½†é«”åŠ›è¡°é€€æ¥µå¿«ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, bst: 65}, desc: "ä¸æ±‚ç¬¬ä¸€ï¼Œä½†æ±‚ä¸åŠ ç­ã€‚æ²’ä»€éº¼äº®é»å°±æ˜¯æœ€å¤§çš„äº®é»ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    const colors = ["#FF5252", "#FFD700", "#E040FB", "#00E676", "#2979FF", "#FF9100", "#40C4FF", "#FF1744", "#F4FF81", "#B2FF59"];

    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];

    function getPrize(rank) {
        if (rank === 1) return "ç¾é‡‘ $2500";
        if (rank >= 2 && rank <= 5) return "æ–°å…‰ç¦®åˆ¸ $1000";
        if (rank >= 6) return `ç¾é‡‘ $${(11-rank)*100}`;
        return "-";
    }

    // --- 3. åˆå§‹åŒ– ---
    function init() {
        if (isAdmin) {
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'block';
        }
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `
                <div class="horse-card-header"><span class="horse-no">NO.${i+1}</span></div>
                <span class="horse-avatar">ğŸ</span>
                <div class="horse-name">${h.trait}</div>
                <div class="horse-desc">${h.desc}</div>
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">æ•ˆç‡</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">é«”åŠ›</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.sta}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">çˆ†ç™¼</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.bst}%"></div></div></div>
                </div>`;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });
        listenFirebase();
    }

    function listenFirebase() {
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (!state && raceStarted) { location.reload(); return; }
            if (state && state.status === 'racing' && !raceStarted) { startTheGame(state.seed, state.participants); }
        });

        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) { 
                    btn.classList.add('taken'); 
                    if (n === myName) { 
                        btn.classList.add('me'); 
                        document.getElementById('user-login').style.display = 'none'; 
                        document.getElementById('setup').style.display = 'block'; 
                    } 
                } else { btn.classList.remove('taken', 'me'); }
            });
        });

        db.ref('assignments').on('value', snap => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`); slot.classList.remove('occupied', 'my-pick');
                const label = slot.querySelector('.occupied-label'); if (label) label.remove();
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) { 
                    if (owner === myName) { slot.classList.add('my-pick'); } 
                    else { 
                        slot.classList.add('occupied'); 
                        const l = document.createElement('div'); l.className = 'occupied-label'; l.innerText = `é¨å£«: ${owner}`; slot.appendChild(l); 
                    } 
                }
            });
        });
    }

    function login(n) { 
        myName = n; 
        db.ref(`users/${n}`).set(true); 
        document.getElementById('bgm').play().catch(() => {});
    }
    
    function selectHorse(idx) { if (myName) db.ref(`assignments/${myName}`).set(idx); }
    
    function resetData() { 
        if (confirm("ã€è­¦å‘Šã€‘é€™å°‡å¼·åˆ¶é‡ç½®å…¨é«”éŠæˆ²ï¼Œé¦¬åŒ¹èˆ‡é€²åº¦å°‡æ­¸é›¶ã€‚ç¢ºå®šå—ï¼Ÿ")) { 
            db.ref().set(null); 
            location.reload(); 
        } 
    }

    // --- 4. è³½é¦¬å¼•æ“ ---
    document.getElementById('start-btn').onclick = function() {
        db.ref('assignments').once('value', snap => {
            const participants = snap.val() || {};
            if (Object.keys(participants).length < 1) return alert("è‡³å°‘éœ€è¦ä¸€äººé¸é¦¬æ‰èƒ½é–‹è³½ï¼");
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: participants });
        });
    };

    function startTheGame(seed, participants) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('snd-start').play();

        const lanesBox = document.getElementById('lanes-box'); lanesBox.innerHTML = "";
        const list = Object.keys(participants).map((name, idx) => ({ name: name, horseData: horseLibrary[participants[name]], color: colors[idx % colors.length] }));
        const laneHeight = 100 / (list.length || 1);
        
        list.forEach(item => {
            const lane = document.createElement('div'); lane.className = 'lane'; lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `
                <div class="horse-container" id="horse-${item.horseData.id}">
                    <div class="status-bubble" id="status-${item.horseData.id}"></div>
                    <div class="horse-icon" style="color:${item.color}">ğŸ</div>
                    <div class="horse-info-mini">
                        <div style="font-size:10px; font-weight:bold;">${item.name}</div>
                        <div class="stamina-mini"><div class="stamina-mini-fill" id="stamina-fill-${item.horseData.id}"></div></div>
                    </div>
                </div>`;
            lanesBox.appendChild(lane);
        });
        runRaceEngine(seed, list);
    }

    function runRaceEngine(seed, list) {
        let seedVal = seed;
        const syncRand = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };
        const horses = list.map(item => ({ ...item.horseData, ownerName: item.name, pos: 10, speed: 0, currStamina: 100, lastEventTime: Date.now() + syncRand()*2000, nextCooldown: 3000 + syncRand()*3000, finished: false, isStalled: false }));
        const finishLine = document.getElementById('track').offsetWidth - 110;
        const start = Date.now();
        
        const timer = setInterval(() => {
            const elapsed = (Date.now() - start) / 1000;
            horses.forEach(h => {
                if (h.finished) return;
                
                // é«”åŠ›æ¶ˆè€—
                if (!h.isStalled) { 
                    let cost = (h.speed * 0.05 + 0.1);
                    if (h.id === 2) cost *= 1.8; // çˆ†è‚ç‹æ¶ˆè€—å¿«
                    if (h.id === 0) cost *= 0.5; // è–ªæ°´å°å·è¶…æŒä¹…
                    h.currStamina = Math.max(0, h.currStamina - cost); 
                }
                
                // é«”åŠ›è€—ç›¡
                if (h.currStamina <= 0 && !h.isStalled) {
                    h.speed = 0; h.isStalled = true; let count = 3;
                    updateBubble(h.id, `ğŸ¤® é«”åŠ›ä¸æ”¯`, "var(--danger)");
                    setTimeout(() => { h.currStamina=80; h.isStalled=false; updateBubble(h.id,"","",false); }, 3000);
                }
                
                // åŠ é€Ÿé‚è¼¯
                if (!h.isStalled) {
                    let acc = syncRand() * 0.25; 
                    if (h.id === 1 && elapsed >= 12) { acc += 1.5; updateBubble(h.id, "ğŸ”¥ ä¸‹ç­è¡åˆºï¼", "var(--sprint)"); }
                    if (h.id === 7 && elapsed >= 18) { acc += 3.0; updateBubble(h.id, "ğŸš€ è¶•æˆªç¨¿ï¼", "var(--sprint)"); }
                    
                    h.speed = ((h.speed * 0.94) + acc + (h.stats.spd * 0.0015));
                    if (h.currStamina < 20) h.speed *= 0.6;
                }

                // éš¨æ©Ÿäº‹ä»¶
                if (Date.now() - h.lastEventTime > h.nextCooldown && !h.isStalled) {
                    h.lastEventTime = Date.now(); h.nextCooldown = 4000 + syncRand()*5000;
                    const r = syncRand(); 
                    if (r < 0.1 && h.id !== 5) { // æ‘”å€’
                        h.speed = 0; h.pos = Math.max(10, h.pos - 30); updateBubble(h.id, "â›¸ï¸ è¢«ç”©é‹çµ†å€’", "#546e7a"); 
                        setTimeout(() => updateBubble(h.id,"","",false), 1500); 
                    }
                    else if (r < 0.2) { // ä¼‘æ¯
                        h.speed = 0; h.isStalled = true; h.currStamina = Math.min(100, h.currStamina + 40); updateBubble(h.id, "ğŸ›Œ è–ªæ°´å°å·æ¨¡å¼", "var(--recover)"); 
                        setTimeout(() => {h.isStalled=false; updateBubble(h.id,"","",false);}, 2000); 
                    }
                }
                
                h.pos += h.speed;
                const el = document.getElementById(`horse-${h.id}`);
                if (el) el.style.left = Math.min(h.pos, finishLine + 30) + 'px';
                
                const sf = document.getElementById(`stamina-fill-${h.id}`);
                if (sf) {
                    sf.style.width = `${h.currStamina}%`;
                    sf.style.background = h.currStamina < 25 ? 'var(--danger)' : 'var(--success)';
                }

                if (h.pos >= finishLine && !h.finished) { 
                    h.finished = true; 
                    finishedHorses.push(h); 
                    if (finishedHorses.length === 1) document.getElementById('snd-win').play();
                    if (finishedHorses.length === horses.length) { clearInterval(timer); setTimeout(showLeaderboard, 1200); } 
                }
            });
        }, 50);
    }

    function updateBubble(id, text, color, display = true) {
        const el = document.getElementById(`status-${id}`); if (el) { el.innerText = text; el.style.display = display ? 'block' : 'none'; el.style.background = color; }
    }

    function showLeaderboard() {
        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        finishedHorses.forEach((h, i) => {
            const rank = i + 1;
            const div = document.createElement('div');
            div.className = `rank-row ${rank <= 3 ? 'rank-top' : ''}`;
            let medal = rank === 1 ? "ğŸ¥‡" : (rank === 2 ? "ğŸ¥ˆ" : (rank === 3 ? "ğŸ¥‰" : `#${rank}`));
            div.innerHTML = `<span>${medal} ${h.ownerName}</span><span class="prize-text">${getPrize(rank)}</span>`;
            list.appendChild(div);
        });
    }
    init();
</script>
</body>
</html>
