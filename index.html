// --- 1. Firebase é…ç½® (å·²å¥—ç”¨æ‚¨çš„é…ç½®) ---
const firebaseConfig = {
  apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
  authDomain: "aiot-d53dc.firebaseapp.com",
  databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
  projectId: "aiot-d53dc",
  storageBucket: "aiot-d53dc.firebasestorage.app",
  messagingSenderId: "1021331253049",
  appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
  measurementId: "G-9YDKS70ZE7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- 2. æ•¸æ“šé…ç½® ---
const horseLibrary = [
    { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95}, desc: "ç©©å®šæ€§æœ€é«˜ï¼Œä¸è¼•æ˜“ç–²å‹ã€‚" },
    { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65}, desc: "å¾ŒåŠæ®µæœƒæœ‰é©šäººçˆ†ç™¼åŠ›ã€‚" },
    { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25}, desc: "è¡åˆºæ¥µå¿«ä½†çºŒèˆªåŠ›æ¥µä½ã€‚" },
    { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60}, desc: "å„é …æ•¸å€¼å¹³å‡ä¸”ç©©å®šã€‚" },
    { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45}, desc: "é€Ÿåº¦å¿«ï¼Œä½†å°å¿ƒæ–·é›»ã€‚" },
    { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85}, desc: "ä¸å®¹æ˜“ç™¼ç”Ÿæ„å¤–å¤±èª¤ã€‚" },
    { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90}, desc: "é»˜é»˜è¶…è»Šçš„è€åŠ›å‹é¸æ‰‹ã€‚" },
    { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70}, desc: "æœ€å¾Œä¸€åˆ»æœƒç™¼æ®æ¥µé™æ½›èƒ½ã€‚" },
    { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50}, desc: "æ•ˆç‡æ¥µé«˜ä½†è€åŠ›ä¸€èˆ¬ã€‚" },
    { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75}, desc: "ç§‘å­¸åˆ†é…é«”åŠ›ä¹‹ç‹ã€‚" }
];

let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
const colors = ["#FF5252", "#FFD700", "#E040FB", "#00E676", "#2979FF", "#FF9100", "#40C4FF", "#FF1744", "#F4FF81", "#B2FF59"];

let myName = "";
const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
let raceStarted = false;
let finishedHorses = [];

// --- 3. åˆå§‹åŒ– ---
function init() {
    if (isAdmin) {
        document.getElementById('admin-dashboard').style.display = 'block';
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('admin-reset-tool').style.display = 'block';
    } else {
        document.getElementById('user-login').style.display = 'block';
    }
    
    // ç”Ÿæˆå§“åæŒ‰éˆ•
    const nameGrid = document.getElementById('name-grid');
    nameGrid.innerHTML = ""; // æ¸…ç©º
    names.forEach(n => {
        const btn = document.createElement('button');
        btn.className = 'name-btn'; 
        btn.id = `name-${n}`; 
        btn.innerText = n;
        btn.onclick = () => login(n);
        nameGrid.appendChild(btn);
    });

    // ç”Ÿæˆé¸é¦¬å¡ç‰‡
    const horseGrid = document.getElementById('select-grid');
    horseGrid.innerHTML = "";
    horseLibrary.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'horse-slot'; div.id = `slot-${i}`;
        div.innerHTML = `
            <b style="font-size:18px; color:var(--gold)">${h.trait}</b>
            <div style="font-size:11px; color:#aaa; margin:5px 0;">${h.desc}</div>
            <div style="height:6px; background:#000; border-radius:3px; overflow:hidden;">
                <div style="width:${h.stats.spd}%; height:100%; background:var(--gold)"></div>
            </div>`;
        div.onclick = () => selectHorse(i);
        horseGrid.appendChild(div);
    });

    listenFirebase();
}

function listenFirebase() {
    // ç›£è½å“ªäº›åå­—å·²è¢«é¸èµ°
    db.ref('users').on('value', snap => {
        const users = snap.val() || {};
        names.forEach(n => {
            const btn = document.getElementById(`name-${n}`);
            if (!btn) return;
            if (users[n]) {
                btn.classList.add('taken');
                // å¦‚æœæ˜¯æˆ‘è‡ªå·±é¸çš„åå­—ï¼Œè·³è½‰åˆ°é¸é¦¬ç•«é¢
                if (n === myName) {
                    document.getElementById('user-login').style.display = 'none';
                    document.getElementById('setup').style.display = 'block';
                }
            } else {
                btn.classList.remove('taken');
            }
        });
    });

    // ç›£è½é¦¬åŒ¹ä½”ç”¨ç‹€æ…‹
    db.ref('assignments').on('value', snap => {
        const assignments = snap.val() || {};
        
        // ç®¡ç†å“¡æ›´æ–° Ready ç‹€æ…‹
        if (isAdmin) {
            const listEl = document.getElementById('ready-status-list');
            listEl.innerHTML = "";
            names.forEach(n => {
                const hasPicked = assignments[n] !== undefined;
                listEl.innerHTML += `<div>${n} ${hasPicked ? '<span class="ready-badge">READY</span>' : ''}</div>`;
            });
        }

        // ç©å®¶æ›´æ–°é¦¬åŒ¹ UI
        horseLibrary.forEach((_, i) => {
            const slot = document.getElementById(`slot-${i}`);
            if (!slot) return;
            slot.classList.remove('occupied', 'my-pick');
            const owner = Object.keys(assignments).find(name => assignments[name] === i);
            if (owner) {
                if (owner === myName) slot.classList.add('my-pick');
                else {
                    slot.classList.add('occupied');
                    // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ¨™ç±¤ï¼Œæ²’æœ‰æ‰åŠ 
                    if(!slot.querySelector('.occupied-label')){
                        const l = document.createElement('div');
                        l.className = 'occupied-label'; l.innerText = `é¨å£«: ${owner}`;
                        slot.appendChild(l);
                    }
                }
            } else {
                const l = slot.querySelector('.occupied-label');
                if(l) l.remove();
            }
        });
    });

    // ç›£è½éŠæˆ²é–‹å§‹æˆ–é‡ç½®
    db.ref('gameState').on('value', snap => {
        const state = snap.val();
        if (!state && raceStarted) {
            location.reload(); // ç®¡ç†å“¡æŒ‰é‡ç½®ï¼Œå…¨é«”é‡æ–°æ•´ç†
        }
        if (state && state.status === 'racing' && !raceStarted) {
            startTheGame(state.seed, state.startTime, state.participants);
        }
    });
}

function login(n) {
    if (raceStarted) return;
    myName = n;
    db.ref(`users/${n}`).set(true);
    // æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
    const bgm = document.getElementById('bgm');
    bgm.play().catch(() => console.log("ç­‰å¾…äº’å‹•å¾Œæ’­æ”¾"));
}

function selectHorse(idx) {
    if (myName) {
        db.ref(`assignments/${myName}`).set(idx);
    }
}

function resetData() {
    if (confirm("ã€ç®¡ç†è€…æ¬Šé™ã€‘ç¢ºå®šè¦é‡ç½®æ‰€æœ‰äººçš„è³‡æ–™ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ")) {
        db.ref().set(null); // Firebase æ¸…ç©ºï¼Œæœƒè§¸ç™¼æ‰€æœ‰äººçš„ location.reload()
    }
}

function triggerStart() {
    db.ref('assignments').once('value', snap => {
        const p = snap.val();
        if (!p || Object.keys(p).length === 0) return alert("é‚„æ²’äººé¸é¦¬ï¼");
        db.ref('gameState').set({
            status: 'racing',
            seed: Math.random(),
            startTime: firebase.database.ServerValue.TIMESTAMP,
            participants: p
        });
    });
}

// --- 4. è³½é¦¬åŒæ­¥å¼•æ“ ---
function startTheGame(seed, startTime, participants) {
    raceStarted = true;
    document.getElementById('setup').style.display = 'none';
    document.getElementById('admin-dashboard').style.display = 'none';
    document.getElementById('user-login').style.display = 'none';
    document.getElementById('track').style.display = 'block';
    
    // é³´æ§
    const snd = document.getElementById('snd-start');
    snd.play();

    const lanesBox = document.getElementById('lanes-box'); 
    lanesBox.innerHTML = "";
    const list = Object.keys(participants).map((name, idx) => ({ 
        name, 
        horseData: horseLibrary[participants[name]], 
        color: colors[idx % colors.length] 
    }));

    const laneHeight = 100 / list.length;
    list.forEach(item => {
        const lane = document.createElement('div'); 
        lane.className = 'lane'; 
        lane.style.height = `${laneHeight}%`;
        lane.innerHTML = `
            <div class="horse-container" id="horse-${item.horseData.id}">
                <div class="horse-icon" style="color:${item.color}">ğŸ</div>
                <div style="font-size:12px; white-space:nowrap;">${item.name}</div>
            </div>`;
        lanesBox.appendChild(lane);
    });

    runSynchronizedEngine(seed, startTime, list);
}

function runSynchronizedEngine(seed, startTime, list) {
    const finishLine = document.getElementById('track').offsetWidth - 130;
    const timer = setInterval(() => {
        const now = Date.now();
        const elapsed = (now - startTime) / 1000; // ç¶“éç§’æ•¸
        if (elapsed < 0) return;

        let allFinished = true;
        list.forEach(item => {
            const h = item.horseData;
            let simPos = 10, simSpd = 0, currentSeed = seed + h.id; 
            const fastRand = () => { currentSeed = (currentSeed * 9301 + 49297) % 233280; return currentSeed / 233280; };

            // ä»¥ 0.1 ç§’ç‚ºæ­¥é•·æ¨¡æ“¬åˆ°ç›®å‰æ™‚é–“é»
            for (let t = 0; t < elapsed; t += 0.1) {
                if (simPos >= finishLine) break;
                let acc = fastRand() * 0.45;
                if (h.id === 1 && t > 15) acc += 1.8; // ä¸‹ç­æˆ°ç¥çˆ†ç™¼
                if (h.id === 2 && t < 10) acc += 1.2; // çˆ†è‚ç‹èµ·æ­¥
                
                simSpd = (simSpd * 0.94) + acc + (h.stats.spd * 0.0018);
                simPos += simSpd;
            }

            const el = document.getElementById(`horse-${h.id}`);
            if (el) el.style.left = Math.min(simPos, finishLine + 40) + 'px';

            if (simPos < finishLine) {
                allFinished = false;
            } else {
                if (!finishedHorses.find(fh => fh.id === h.id)) {
                    finishedHorses.push({ ...h, ownerName: item.name });
                    if (finishedHorses.length === 1) document.getElementById('snd-win').play();
                }
            }
        });

        if (allFinished && list.length > 0) { 
            clearInterval(timer); 
            showLeaderboard(); 
        }
    }, 100);
}

function showLeaderboard() {
    document.getElementById('leaderboard').style.display = 'block';
    const listEl = document.getElementById('leaderboard-list');
    listEl.innerHTML = "";
    finishedHorses.forEach((h, i) => {
        listEl.innerHTML += `
            <div class="rank-row">
                <span>#${i+1} ${h.ownerName}</span>
                <span style="color:var(--primary)">${getPrize(i+1)}</span>
            </div>`;
    });
}

function getPrize(rank) {
    if (rank === 1) return "$2500";
    if (rank <= 5) return "$1000åˆ¸";
    if (rank === 6) return "$500";
    return "$100èµ·";
}

init();
