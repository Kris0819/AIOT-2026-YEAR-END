<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å°¾ç‰™è³½é¦¬åŒæ­¥ç³»çµ± (POç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        .horse-track { height: 60px; border-bottom: 2px solid #f1f5f9; position: relative; background: #fff; }
        .horse-emoji { font-size: 36px; position: absolute; transition: left 0.3s linear; bottom: 4px; z-index: 10; }
        .name-tag { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 10px; background: #4f46e5; color: white; padding: 1px 4px; border-radius: 4px; white-space: nowrap; }
        .event-popup { position: absolute; top: -25px; color: #ef4444; font-weight: bold; font-size: 12px; white-space: nowrap; }
        .finish-line { position: absolute; right: 40px; top: 0; bottom: 0; border-left: 4px dashed #cbd5e1; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="max-w-xl mx-auto p-4 min-h-screen">
        <header class="text-center py-4">
            <h1 class="text-3xl font-black text-indigo-700">ğŸ RACING 2026</h1>
        </header>

        <section id="step-user" class="bg-white p-6 rounded-3xl shadow-xl border-2 border-indigo-100">
            <h2 class="text-lg font-bold mb-4">ğŸ‘¤ è«‹é»é¸ä½ çš„åå­—</h2>
            <div id="user-list" class="grid grid-cols-2 gap-2"></div>
        </section>

        <section id="step-horse" class="bg-white p-6 rounded-3xl shadow-xl border-2 border-indigo-100 hidden">
            <h2 class="text-lg font-bold mb-4">ğŸ æŒ‘é¸æˆ°é¦¬</h2>
            <div id="horse-selection" class="space-y-2"></div>
        </section>

        <section id="step-race" class="hidden">
            <div id="race-status" class="text-center font-bold text-indigo-600 mb-2 bg-white p-2 rounded-xl shadow">ç­‰å¾…é–‹è³½...</div>
            <div id="track-container" class="bg-white rounded-2xl shadow-xl overflow-hidden relative">
                <div class="finish-line"></div>
                </div>
        </section>

        <div id="step-result" class="mt-4 hidden">
            <div class="bg-yellow-400 p-4 rounded-2xl shadow-xl">
                <h2 class="text-xl font-bold text-center mb-2">ğŸ† æœ€çµ‚åæ¬¡</h2>
                <div id="rank-list" class="space-y-1"></div>
            </div>
        </div>

        <section id="admin-panel" class="hidden mt-8 p-4 bg-slate-900 text-white rounded-2xl shadow-2xl">
            <h2 class="text-lg font-bold mb-2 text-indigo-400">ç®¡ç†è€…æ§åˆ¶å°</h2>
            <div id="admin-info" class="text-xs mb-4 text-gray-400"></div>
            <div class="flex gap-2">
                <button onclick="calculateAndStart()" class="bg-green-600 px-4 py-2 rounded-lg font-bold flex-1">ç”Ÿæˆè·¯å¾‘ä¸¦é–‹è³½</button>
                <button onclick="resetGame()" class="bg-red-600 px-4 py-2 rounded-lg font-bold flex-1">é‡ç½®</button>
            </div>
        </section>
    </div>

    <audio id="bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
            authDomain: "aiot-d53dc.firebaseapp.com",
            databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
            projectId: "aiot-d53dc",
            storageBucket: "aiot-d53dc.firebasestorage.app",
            messagingSenderId: "1021331253049",
            appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
            measurementId: "G-9YDKS70ZE7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const players = ["Julia", "Molly", "Juli", "è±ªå“¥", "Don", "Gimme", "å‰å¿—", "Erick", "Jason", "KRIS"];
        const horses = ["ğŸ", "âš¡", "ğŸ¦„", "ğŸ¦“", "ğŸ¦™", "ğŸ¥³", "ğŸ ", "ğŸ–ï¸", "ğŸ¤–", "ğŸ"];
        const prizes = ["$2500", "æ–°å…‰1000", "500å·", "400å·", "300å·", "200å·", "100å·", "åƒåŠ ç", "åƒåŠ ç", "åƒåŠ ç"];

        let myName = "";
        let raceInterval;

        function init() {
            if(window.location.hash === '#admin') document.getElementById('admin-panel').classList.remove('hidden');

            db.ref('gameState').on('value', snapshot => {
                const state = snapshot.val() || {};
                renderUserList(state.selections || {});
                renderHorseSelection(state.selections || {});
                
                if (state.status === 'racing') {
                    startSyncRace(state);
                } else if (state.status === 'waiting') {
                    stopRace();
                    resetUI();
                }

                // ç®¡ç†è€…é¡¯ç¤ºå°šæœªé¸çš„äºº
                if(window.location.hash === '#admin') {
                    const selected = Object.keys(state.selections || {});
                    const unselected = players.filter(p => !selected.includes(p));
                    document.getElementById('admin-info').innerText = "æœªé¸æ“‡: " + unselected.join(', ');
                }
            });
        }

        // --- æ ¸å¿ƒåŒæ­¥é‚è¼¯ ---
        function startSyncRace(state) {
            document.getElementById('step-user').classList.add('hidden');
            document.getElementById('step-horse').classList.add('hidden');
            document.getElementById('step-race').classList.remove('hidden');
            document.getElementById('bgm').play();

            const trackContainer = document.getElementById('track-container');
            if (trackContainer.children.length <= 1) { // åƒ…åˆå§‹åŒ–ä¸€æ¬¡è³½é“
                Object.entries(state.selections).forEach(([name, data]) => {
                    const div = document.createElement('div');
                    div.className = "horse-track";
                    div.innerHTML = `
                        <div id="horse-${data.horseId}" class="horse-emoji" style="left:0%">
                            <span class="name-tag">${name}</span>${horses[data.horseId]}
                            <div class="event-msg" id="event-${data.horseId}"></div>
                        </div>`;
                    trackContainer.appendChild(div);
                });
            }

            // åŒæ­¥æ’­æ”¾å™¨ï¼šæ ¹æ“šä¼ºæœå™¨æ™‚é–“æ±ºå®šç›®å‰æ‡‰è©²åœ¨å“ªå€‹å½±æ ¼
            clearInterval(raceInterval);
            raceInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = Math.floor((now - state.startTime) / 200); // æ¯0.2ç§’ä¸€å€‹å½±æ ¼
                
                if (elapsed < 0) return; // æ¯”è³½é‚„æ²’é–‹å§‹ï¼ˆå€’æ•¸è¨ˆæ™‚ï¼‰

                let finishedCount = 0;
                Object.entries(state.pathData).forEach(([hId, path]) => {
                    const horseEl = document.getElementById(`horse-${hId}`);
                    const eventEl = document.getElementById(`event-${hId}`);
                    const frame = path[elapsed] || path[path.length - 1]; // è‹¥è¶…éæ™‚é–“ï¼Œåœåœ¨æœ€å¾Œä¸€æ ¼
                    
                    if (horseEl) horseEl.style.left = frame.pos + "%";
                    if (eventEl && frame.event) eventEl.innerText = frame.event;
                    else if (eventEl) eventEl.innerText = "";

                    if (elapsed >= path.length) finishedCount++;
                });

                if (finishedCount === Object.keys(state.pathData).length) {
                    clearInterval(raceInterval);
                    showFinalRank(state.rankings);
                }
            }, 100);
        }

        // --- ç®¡ç†è€…ï¼šé å…ˆè¨ˆç®—è·¯å¾‘ ---
        function calculateAndStart() {
            db.ref('gameState/selections').once('value', snapshot => {
                const selections = snapshot.val();
                if (!selections) return alert("é‚„æ²’äººé¸é¦¬ï¼");

                const pathData = {};
                const rankings = [];
                const horseIds = Object.values(selections).map(s => s.horseId);

                horseIds.forEach(id => {
                    let pos = 0;
                    const path = [];
                    for (let i = 0; i < 200; i++) { // æœ€é•·è·‘ 200 å€‹å½±æ ¼
                        let move = Math.random() * 2 + 0.5;
                        let event = "";
                        
                        const roll = Math.random();
                        if (roll < 0.03) { move = -3; event = "ğŸŒ æ»‘å€’"; }
                        else if (roll > 0.97) { move = 8; event = "ğŸ”¥ çˆ†ç™¼"; }
                        else if (roll > 0.5 && roll < 0.51) { move = -pos; event = "ğŸ’» Bug!"; }

                        pos = Math.min(88, Math.max(0, pos + move));
                        path.push({ pos, event });
                        if (pos >= 88 && !rankings.includes(id)) {
                            // è¨˜éŒ„æŠµé”å½±æ ¼
                        }
                    }
                    pathData[id] = path;
                });

                // æ ¹æ“šè·¯å¾‘ä¸­èª°å…ˆé”åˆ° 88% è¨ˆç®—åæ¬¡
                const finishTimes = horseIds.map(id => ({
                    id,
                    time: pathData[id].findIndex(f => f.pos >= 88)
                })).sort((a, b) => a.time - b.time);

                const finalRankings = finishTimes.map(f => {
                    const name = Object.keys(selections).find(k => selections[k].horseId === f.id);
                    return { name, horseId: f.id };
                });

                db.ref('gameState').update({
                    status: 'racing',
                    startTime: Date.now() + 3000, // 3ç§’å¾Œæ­£å¼é–‹å§‹
                    pathData: pathData,
                    rankings: finalRankings
                });
            });
        }

        // --- UI æ¸²æŸ“ ---
        function renderUserList(selections) {
            const list = document.getElementById('user-list');
            if (list.children.length > 0) {
                // æ›´æ–°ç‹€æ…‹å°±å¥½ï¼Œä¸é‡ç¹ªä»¥å…è·‘æ‰
                players.forEach((p, i) => {
                    const btn = list.children[i];
                    if (selections[p]) {
                        btn.classList.add('bg-gray-200', 'text-gray-400', 'pointer-events-none');
                        btn.innerText = p + " (å·²ç™»å…¥)";
                    }
                });
                return;
            }
            players.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "p-3 bg-white border-2 border-indigo-500 text-indigo-700 rounded-xl font-bold transition active:scale-95";
                btn.innerText = p;
                btn.onclick = () => {
                    myName = p;
                    document.getElementById('step-user').classList.add('hidden');
                    document.getElementById('step-horse').classList.remove('hidden');
                };
                list.appendChild(btn);
            });
        }

        function renderHorseSelection(selections) {
            const container = document.getElementById('horse-selection');
            container.innerHTML = "";
            const pickedIds = Object.values(selections).map(s => s.horseId);
            horses.forEach((emoji, id) => {
                const owner = Object.keys(selections).find(k => selections[k].horseId === id);
                const isTaken = !!owner;
                const div = document.createElement('div');
                div.className = `p-3 border-2 rounded-xl flex justify-between items-center ${isTaken ? 'bg-gray-100 border-gray-200' : 'border-indigo-400'}`;
                div.innerHTML = `<span>${emoji} é¦¬åŒ¹ ${id+1}</span> <span class="font-bold">${isTaken ? owner : 'é»æ“Šé¸æ“‡'}</span>`;
                if(!isTaken) div.onclick = () => {
                    db.ref(`gameState/selections/${myName}`).set({ horseId: id });
                    document.getElementById('step-horse').classList.add('hidden');
                    document.getElementById('step-race').classList.remove('hidden');
                };
                container.appendChild(div);
            });
        }

        function showFinalRank(ranks) {
            document.getElementById('step-result').classList.remove('hidden');
            const list = document.getElementById('rank-list');
            list.innerHTML = "";
            ranks.forEach((r, i) => {
                const div = document.createElement('div');
                div.className = "flex justify-between p-2 bg-white rounded-lg shadow-sm mb-1 text-sm";
                div.innerHTML = `<span>ç¬¬${i+1}å: <b>${r.name}</b></span> <span class="text-indigo-600">${prizes[i] || 'çåˆ¸'}</span>`;
                list.appendChild(div);
            });
            document.getElementById('race-status').innerText = "ğŸ æ¯”è³½çµæŸï¼";
        }

        function stopRace() { clearInterval(raceInterval); }
        function resetUI() { location.reload(); }
        function resetGame() { db.ref('gameState').set({ status: 'waiting', selections: {} }); }

        init();
    </script>
</body>
</html>
