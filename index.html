<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>2026 AIOT åƒç´ å°¾ç‰™è³½é¦¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* æ˜Ÿéœ²è°·ç‰©èªæ°›åœé…è‰² */
        :root {
            --pixel-bg: #5d8a7b; /* è‰åœ°ç¶  */
            --wood-dark: #63352d;
            --wood-light: #b45229;
            --paper: #f7e6ad;
            --gold: #ffcc00;
            --primary: #d32f2f;
            --success: #6abe30;
        }

        @font-face {
            font-family: 'PixelFont';
            src: url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap'); /* æš«ä»¥åœ“æ½¤å­—é«”æ¨¡æ“¬ */
        }

        body {
            font-family: 'ZCOOL KuaiLe', 'PingFang TC', cursive;
            background-color: var(--pixel-bg);
            background-image: radial-gradient(#4d7a6b 2px, transparent 2px);
            background-size: 20px 20px;
            color: var(--wood-dark);
            margin: 0; padding: 10px;
            height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }

        /* åƒç´ é¢¨é‚Šæ¡† */
        .pixel-border {
            border: 4px solid var(--wood-dark);
            box-shadow: 
                0 4px 0 0 var(--wood-dark),
                0 -4px 0 0 var(--wood-dark),
                4px 0 0 0 var(--wood-dark),
                -4px 0 0 0 var(--wood-dark),
                inset -4px -4px 0 0 #8d4a36;
            background: var(--paper);
        }

        /* ç™»å…¥èˆ‡é¸é¦¬å€ */
        #user-login, .setup-area {
            padding: 20px; border-radius: 0; text-align: center;
            width: 90%; max-width: 600px; margin-top: 50px;
        }

        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .name-btn {
            background: #fff; border: 3px solid var(--wood-dark);
            padding: 12px; cursor: pointer; font-size: 18px; font-weight: bold;
            box-shadow: 2px 2px 0 var(--wood-dark); transition: 0.1s;
        }
        .name-btn:active { transform: translate(2px, 2px); box-shadow: 0 0 0; }
        .name-btn.taken { background: #d1d1d1; color: #888; pointer-events: none; }

        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        .horse-slot {
            background: #fff; border: 3px solid var(--wood-dark); padding: 10px;
            cursor: pointer; position: relative; transition: 0.2s;
        }
        .horse-slot:hover { background: #fffdf0; transform: scale(1.02); }
        .horse-slot.my-pick { background: #e0f8cf; border-color: var(--success); }
        .horse-slot.occupied { opacity: 0.4; filter: grayscale(1); pointer-events: none; }

        .stat-bar { height: 8px; background: #eee; border: 1px solid var(--wood-dark); margin: 2px 0; }
        .stat-fill { height: 100%; background: var(--wood-light); }

        /* è³½é“ */
        .track-container {
            width: 98vw; flex-grow: 1; display: none; margin-top: 10px;
            background: #71aa34; border: 6px solid var(--wood-dark);
            background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100% 40px; position: relative;
        }
        .finish-line {
            position: absolute; right: 80px; top: 0; bottom: 0; width: 12px;
            background: #fff; border-left: 4px dashed var(--primary);
        }
        .lane { position: relative; border-bottom: 2px solid rgba(0,0,0,0.1); display: flex; align-items: center; }

        /* é¦¬åŒ¹å‹•ç•« */
        @keyframes gallop {
            0% { transform: translateY(0) scaleX(-1); }
            50% { transform: translateY(-4px) scaleX(-1); }
            100% { transform: translateY(0) scaleX(-1); }
        }
        .horse-container { position: absolute; left: 10px; display: flex; align-items: center; }
        .horse-icon { font-size: 32px; animation: gallop 0.4s infinite; }

        /* æ’è¡Œæ¦œ */
        #leaderboard {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; z-index: 1000; display: none; padding: 20px;
        }
        .prize-tag { color: var(--primary); font-weight: bold; }

        #start-btn {
            background: var(--gold); border: 4px solid var(--wood-dark);
            padding: 15px 40px; font-size: 24px; cursor: pointer;
            margin: 20px; box-shadow: 4px 4px 0 var(--wood-dark); display: none;
        }
    </style>
</head>
<body>

    <h2 style="color: white; text-shadow: 3px 3px 0 var(--wood-dark); letter-spacing: 2px;">ğŸŒ¾ AIOT åƒç´ è³½é¦¬ç‰§å ´ ğŸŒ¾</h2>

    <div id="user-login" class="pixel-border">
        <h2 style="margin: 0;">ä½ æ˜¯èª°ï¼Ÿ</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area pixel-border" style="display:none;">
        <h3 id="who-am-i" style="background: var(--wood-dark); color: white; padding: 5px; margin: -20px -20px 10px -20px;"></h3>
        <p>è«‹æŒ‘é¸ä¸€åŒ¹å¥½é¦¬åƒåŠ æ¯”è³½ï¼š</p>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <button id="start-btn" class="pixel-font">ğŸ é–‹å§‹æ¯”è³½ (Admin)</button>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; display: flex; flex-direction: column;"></div>
    </div>

    <div id="leaderboard" class="pixel-border">
        <h2 style="text-align:center; margin: 0;">ğŸ† æ¯”è³½çµæœ</h2>
        <div id="leaderboard-list" style="margin: 15px 0;"></div>
        <button onclick="location.reload()" style="width:100%; padding:10px; cursor:pointer;">è¿”å›é‡æ–°é–‹å§‹</button>
    </div>

<script>
    // --- 1. Firebase é…ç½® ---
    const firebaseConfig = {
  apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
  authDomain: "aiot-d53dc.firebaseapp.com",
  databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
  projectId: "aiot-d53dc",
  storageBucket: "aiot-d53dc.firebasestorage.app",
  messagingSenderId: "1021331253049",
  appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
  measurementId: "G-9YDKS70ZE7"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. æ•¸æ“š ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 60, sta: 95, desc: "é«”åŠ›å……æ²›çš„æ‘¸é­šé«˜æ‰‹" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 50, sta: 65, desc: "çµ‚é»å‰æœƒç˜‹ç‹‚è¡åˆº" },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 95, sta: 25, desc: "é€Ÿåº¦æ¥µå¿«ä½†æ˜“éå‹" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", spd: 75, sta: 60, desc: "è¡¨ç¾éå¸¸ç©©å®š" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", spd: 80, sta: 45, desc: "çˆ†ç™¼åŠ›å¼·ä½†é«”åŠ›ä¸ç©©" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", spd: 45, sta: 85, desc: "å¾ä¸å¤±èª¤çš„é‹æ°£ç‹" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = ""; // æ”¹æˆä¸è¨˜æ†¶èº«ä»½
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];

    function getPrize(rank) {
        const prizes = {1:"$2500", 2:"$1000ç¦®åˆ¸", 3:"$1000ç¦®åˆ¸", 4:"$1000ç¦®åˆ¸", 5:"$1000ç¦®åˆ¸", 6:"$500", 7:"$400", 8:"$300", 9:"$200", 10:"$100"};
        return prizes[rank] || "-";
    }

    // --- 3. é‚è¼¯ ---
    function init() {
        if (isAdmin) document.getElementById('start-btn').style.display = 'block';
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="font-size:24px; transform: scaleX(-1);">ğŸ</div>
                <b style="color:var(--wood-light);">${h.trait}</b>
                <div class="stat-bar"><div class="stat-fill" style="width:${h.spd}%"></div></div>
                <div style="font-size:10px; color:#666;">${h.desc}</div>
            `;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });
        listenFirebase();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) btn.classList.add('taken'); else btn.classList.remove('taken');
            });
        });

        db.ref('assignments').on('value', snap => {
            const assignments = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) {
                    if (owner === myName) slot.classList.add('my-pick');
                    else slot.classList.add('occupied');
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) startTheGame(state.seed, state.participants);
        });
    }

    function login(n) {
        myName = n;
        document.getElementById('user-login').style.display = 'none';
        document.getElementById('setup').style.display = 'block';
        document.getElementById('who-am-i').innerText = `ä½ å¥½ï¼Œ${myName}ï¼`; // æç¤ºç›®å‰æ˜¯èª°
        db.ref(`users/${n}`).set(true);
    }

    function selectHorse(idx) { if (myName) db.ref(`assignments/${myName}`).set(idx); }

    document.getElementById('start-btn').onclick = () => {
        db.ref('assignments').once('value', snap => {
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: snap.val() || {} });
        });
    };

    function startTheGame(seed, participants) {
        raceStarted = true;
        document.querySelectorAll('#setup, #start-btn, #user-login').forEach(el => el.style.display = 'none');
        document.getElementById('track').style.display = 'block';

        const lanesBox = document.getElementById('lanes-box');
        const list = Object.keys(participants).map(name => ({ name: name, horseData: horseLibrary[participants[name]] }));
        const laneHeight = 100 / (list.length || 1);

        list.forEach(item => {
            const lane = document.createElement('div');
            lane.className = 'lane'; lane.style.height = `${laneHeight}%`;
            lane.innerHTML = `<div class="horse-container" id="horse-${item.horseData.id}"><div class="horse-icon">ğŸ</div><div style="font-size:12px; margin-left:5px; font-weight:bold;">${item.name}</div></div>`;
            lanesBox.appendChild(lane);
        });

        runEngine(seed, list);
    }

    function runEngine(seed, list) {
        let seedVal = seed;
        const syncRand = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };
        const horses = list.map(item => ({ ...item.horseData, ownerName: item.name, pos: 10, speed: 0, finished: false }));
        const finishLine = document.getElementById('track').offsetWidth - 120;

        const timer = setInterval(() => {
            horses.forEach(h => {
                if (h.finished) return;
                h.speed = (h.speed * 0.95) + (syncRand() * 0.5) + (h.spd * 0.001);
                h.pos += h.speed;
                document.getElementById(`horse-${h.id}`).style.left = h.pos + 'px';

                if (h.pos >= finishLine) {
                    h.finished = true; finishedHorses.push(h);
                    if (finishedHorses.length === horses.length) { clearInterval(timer); showLeaderboard(); }
                }
            });
        }, 50);
    }

    function showLeaderboard() {
        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leaderboard-list');
        finishedHorses.forEach((h, i) => {
            const div = document.createElement('div');
            div.style.padding = "8px"; div.style.borderBottom = "1px solid #ddd";
            div.innerHTML = `<b>#${i+1} ${h.ownerName}</b> - <span class="prize-tag">${getPrize(i+1)}</span>`;
            list.appendChild(div);
        });
    }

    init();
</script>
</body>
</html>
