<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIOT 2026 è³½é¦¬ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #FFD700; --red: #ff4757; --dark: #121212; --card: #1e1e1e; --success: #2ed573; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--dark); color: white; margin: 0; padding-bottom: 50px; }

        /* ç®¡ç†å“¡å°ˆç”¨é¢æ¿ */
        #admin-panel { 
            background: var(--red); padding: 10px; text-align: center; 
            position: sticky; top: 0; z-index: 1000; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .admin-btn { background: white; color: var(--red); border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 0 5px; }

        .container { padding: 15px; }
        .title { text-align: center; color: var(--gold); margin: 20px 0; }

        /* é¸é¦¬å¡ç‰‡å„ªåŒ– */
        .horse-list { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .horse-card {
            background: var(--card); border-radius: 12px; padding: 20px;
            border: 2px solid #333; position: relative; transition: 0.3s;
        }
        .horse-card.selected { border-color: var(--success); background: #1a2e23; }
        .horse-card.occupied { opacity: 0.6; filter: grayscale(0.8); pointer-events: none; }
        
        .occupant-tag {
            position: absolute; top: 10px; right: 10px;
            background: var(--gold); color: black; padding: 4px 8px;
            border-radius: 4px; font-size: 12px; font-weight: bold;
        }

        .stat-bar-bg { width: 100%; height: 8px; background: #000; border-radius: 4px; margin-top: 5px; }
        .stat-fill { height: 100%; border-radius: 4px; transition: width 1s; }

        /* å§“åé¸æ“‡å€ */
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .name-btn { 
            padding: 15px; background: #2f3542; border: none; color: white; 
            border-radius: 8px; font-size: 16px; font-weight: bold;
        }
        .name-btn.taken { background: #1e1e1e; color: #555; pointer-events: none; }
        .name-btn.me { background: var(--success); box-shadow: 0 0 10px var(--success); }
    </style>
</head>
<body>

    <div id="admin-panel">
        <span style="font-size:12px;">ğŸ›¡ï¸ ç®¡ç†å“¡æ¨¡å¼:</span>
        <button class="admin-btn" onclick="resetGame()">ğŸ§¹ é‡ç½®å…¨å ´</button>
        <button class="admin-btn" onclick="startRace()">ğŸ é–‹è³½</button>
    </div>

    <div id="view-login" class="container">
        <h2 class="title">èº«ä»½ç¢ºèª</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="view-setup" class="container" style="display:none;">
        <h2 class="title">æŒ‘é¸æˆ°é¦¬ (ä¸€äººä¸€é¦¬)</h2>
        <div class="horse-list" id="horse-list"></div>
    </div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 55, sta: 95, color: "#2ed573", desc: "é«”åŠ›æ¥µå¥½ï¼Œé©åˆé•·è·‘" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 45, sta: 60, color: "#ffa502", desc: "æœ€å¾Œè¡åˆºæœƒå•Ÿå‹•ç‹‚æš´æ¨¡å¼" },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 95, sta: 20, color: "#ff4757", desc: "åˆæœŸæ¥µå¿«ï¼Œä½†æ¥µé€Ÿæ¶ˆè€—é«”åŠ›" },
        { id: 3, trait: "å’–å•¡ä¸­æ¯’", spd: 75, sta: 45, color: "#1e90ff", desc: "é€Ÿåº¦èµ·ä¼å¤§ï¼Œå……æ»¿é©šå–œ" },
        { id: 4, trait: "ç”©é‹å°ˆå®¶", spd: 60, sta: 70, color: "#eccc68", desc: "ç©©å®šå‹é¦¬åŒ¹ï¼Œç„¡è¦–è² é¢äº‹ä»¶" }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';

        // åˆå§‹åŒ–å§“ååˆ—è¡¨
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `user-btn-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        // åˆå§‹åŒ–é¦¬åŒ¹åˆ—è¡¨
        const list = document.getElementById('horse-list');
        horseLibrary.forEach((h, i) => {
            const card = document.createElement('div');
            card.className = 'horse-card'; card.id = `h-card-${i}`;
            card.innerHTML = `
                <div id="tag-${i}"></div>
                <div style="font-size:20px; font-weight:bold; color:var(--gold);">${h.trait}</div>
                <div style="font-size:12px; color:#aaa; margin-bottom:10px;">${h.desc}</div>
                <div style="font-size:12px;">é€Ÿåº¦</div>
                <div class="stat-bar-bg"><div class="stat-fill" style="width:${h.spd}%; background:${h.color};"></div></div>
                <div style="font-size:12px; margin-top:5px;">è€åŠ›</div>
                <div class="stat-bar-bg"><div class="stat-fill" style="width:${h.sta}%; background:#555;"></div></div>
            `;
            card.onclick = () => selectHorse(i);
            list.appendChild(card);
        });

        syncFirebase();
    }

    // --- æ ¸å¿ƒåŒæ­¥é‚è¼¯ ---
    function syncFirebase() {
        // ç›£è½æ‰€æœ‰äººçš„é¸é¦¬ç‹€æ…‹
        db.ref('assignments').on('value', snap => {
            const data = snap.val() || {};
            // å…ˆé‡ç½®æ‰€æœ‰å¡ç‰‡ç‹€æ…‹
            document.querySelectorAll('.horse-card').forEach(c => {
                c.classList.remove('occupied', 'selected');
                const tag = c.querySelector('[id^="tag-"]');
                if(tag) tag.innerHTML = '';
            });

            // æ¨™è¨˜å·²è¢«é¸èµ°çš„é¦¬
            Object.entries(data).forEach(([user, horseIdx]) => {
                const card = document.getElementById(`h-card-${horseIdx}`);
                const tag = document.getElementById(`tag-${horseIdx}`);
                if(card) {
                    if (user === myName) {
                        card.classList.add('selected');
                        tag.innerHTML = `<span class="occupant-tag">ä½ çš„é¦¬</span>`;
                    } else {
                        card.classList.add('occupied');
                        tag.innerHTML = `<span class="occupant-tag">é¨å£«: ${user}</span>`;
                    }
                }
            });
        });

        // ç›£è½ä½¿ç”¨è€…ç™»å…¥
        db.ref('users').on('value', snap => {
            const data = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`user-btn-${n}`);
                if (data[n]) {
                    btn.classList.add('taken');
                    if (n === myName) btn.classList.add('me');
                } else {
                    btn.classList.remove('taken', 'me');
                }
            });
            if (data[myName]) {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-setup').style.display = 'block';
            } else {
                // å¦‚æœç®¡ç†å“¡æ¸…ç©ºäº†è³‡æ–™ï¼Œå¼·åˆ¶è·³å›ç™»å…¥
                document.getElementById('view-login').style.display = 'block';
                document.getElementById('view-setup').style.display = 'none';
                myName = "";
            }
        });
    }

    function login(n) {
        myName = n;
        db.ref(`users/${n}`).set(true);
    }

    function selectHorse(idx) {
        if (!myName) return;
        // å…ˆæª¢æŸ¥é€™åŒ¹é¦¬æœ‰æ²’æœ‰äººé¸ (é˜²æ­¢æ‰‹é€Ÿç«¶çˆ­)
        db.ref('assignments').once('value', snap => {
            const data = snap.val() || {};
            const isTaken = Object.values(data).includes(idx);
            const myOldPick = data[myName];

            if (isTaken && myOldPick !== idx) {
                alert("æ…¢äº†ä¸€æ­¥ï¼é€™åŒ¹é¦¬å‰›è¢«é¸èµ°äº†ã€‚");
            } else {
                db.ref(`assignments/${myName}`).set(idx);
            }
        });
    }

    // --- ç®¡ç†å“¡åŠŸèƒ½ ---
    function resetGame() {
        if (confirm("ã€è­¦å‘Šã€‘å°‡é‡ç½®æ‰€æœ‰ç©å®¶ç™»å…¥ç‹€æ…‹èˆ‡é¸é¦¬çµæœï¼Œç¢ºå®šå—ï¼Ÿ")) {
            db.ref().set(null); // æ¸…ç©ºå…¨åŸŸ
            alert("æ•¸æ“šå·²æ¸…ç©º");
        }
    }

    function startRace() {
        // è·³è½‰åˆ°è³½é¦¬ç•«é¢é‚è¼¯
        alert("æº–å‚™é–‹è³½ï¼(æ­£åœ¨å•Ÿå‹•åŒæ­¥å¼•æ“)");
        // é€™è£¡å¯ä»¥å‘¼å«ä¹‹å‰çš„è³½é¦¬ UI é‚è¼¯...
    }

    init();
</script>
</body>
</html>
