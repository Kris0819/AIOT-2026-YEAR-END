<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIOT 2026 å°¾ç‰™è³½é¦¬</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --gold: #FFD700; --red: #E91E63; --dark: #121212; 
            --card: #1E1E1E; --accent: #00E5FF;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, 'PingFang TC', sans-serif;
            background: var(--dark); color: white; margin: 0; padding: 0;
            overflow-x: hidden;
        }

        /* æ‰‹æ©Ÿç«¯å°èˆªæ¬„ */
        .mobile-header {
            padding: 15px; text-align: center; background: #000;
            border-bottom: 2px solid var(--gold); sticky: top; top: 0; z-index: 100;
        }

        /* é¸äººèˆ‡é¸é¦¬å¡ç‰‡ */
        .container { padding: 15px; padding-bottom: 50px; }
        .horse-card {
            background: var(--card); border-radius: 15px; padding: 15px;
            margin-bottom: 15px; border: 2px solid #333; transition: 0.3s;
            position: relative;
        }
        .horse-card.selected { border-color: var(--gold); background: #2a2a10; }
        .horse-card.taken { opacity: 0.5; pointer-events: none; grayscale: 1; }

        .stat-row { display: flex; align-items: center; margin: 5px 0; font-size: 13px; }
        .stat-label { width: 40px; color: #888; }
        .stat-bar-bg { flex: 1; height: 6px; background: #000; border-radius: 3px; margin: 0 10px; }
        .stat-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }

        /* è³½é“ - å‚ç›´æ¨¡å¼å„ªåŒ– */
        #track { 
            display: none; height: calc(100vh - 80px); background: #1a1a1a;
            position: relative; overflow: hidden;
        }
        .lane {
            position: relative; width: 100%; border-bottom: 1px solid #333;
            display: flex; align-items: center;
        }
        .horse-sprite {
            position: absolute; width: 50px; text-align: center;
            transition: left 0.1s linear;
        }
        .finish-gate {
            position: absolute; right: 60px; top: 0; bottom: 0;
            width: 20px; background: repeating-linear-gradient(0deg, #fff 0 10px, #000 10px 20px);
        }

        /* æµ®å‹•å…¬å‘Š */
        #status-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px;
            border: 1px solid var(--gold); z-index: 1000; font-size: 14px; display: none;
        }

        /* ç™»å…¥ Grid */
        .login-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .login-btn {
            padding: 20px; background: #333; border-radius: 10px; border: none;
            color: white; font-weight: bold; font-size: 16px;
        }
        .login-btn.taken { background: #111; color: #555; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <h2 style="margin:0; font-size: 18px; color: var(--gold);">ğŸ AIOT 2026 é¦¬å¹´ç«¶é€Ÿ</h2>
        <div id="user-display" style="font-size: 12px; color: #888;">å°šæœªç™»å…¥</div>
    </div>

    <div id="view-login" class="container">
        <h3 style="text-align:center;">é¸æ“‡æ‚¨çš„èº«ä»½</h3>
        <div class="login-grid" id="login-grid"></div>
    </div>

    <div id="view-setup" class="container" style="display:none;">
        <h3 style="text-align:center; color: var(--gold);">æŒ‘é¸åƒè³½æˆ°é¦¬</h3>
        <div id="horse-list"></div>
        <button id="admin-start" style="display:none; width:100%; padding:20px; background:var(--red); border:none; color:white; border-radius:15px; font-weight:bold; font-size:18px; margin-top:20px;">æˆ‘æ˜¯ç®¡ç†å“¡ï¼Œé–‹å•Ÿæ¯”è³½ï¼</button>
    </div>

    <div id="track">
        <div class="finish-gate"></div>
        <div id="lanes-container" style="height:100%;"></div>
    </div>

    <div id="leaderboard" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; padding:40px;">
        <h1 style="text-align:center; color:var(--gold);">ğŸ† æ¯”è³½çµæŸ</h1>
        <div id="rank-list"></div>
        <button onclick="location.reload()" style="width:100%; margin-top:30px; padding:15px; border-radius:10px;">å›é¦–é </button>
    </div>

    <div id="status-msg"></div>

<script>
    // --- Firebase Config (User Saved) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- éŠæˆ²é‚è¼¯è³‡æ–™ ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 50, sta: 90, str: 30, color: "#4CAF50", desc: "ç©©å®šè¼¸å‡ºï¼Œå®Œå…¨ä¸æœƒç´¯" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 40, sta: 50, str: 99, color: "#FF5722", desc: "æœ€å¾Œéšæ®µçˆ†ç™¼åŠ›å…¨å ´ç¬¬ä¸€" },
        { id: 2, trait: "çˆ†è‚ç‹", spd: 90, sta: 20, str: 70, color: "#E91E63", desc: "èµ·æ­¥æ¥µå¿«ï¼Œä½†é«”åŠ›å®¹æ˜“è¦‹åº•" },
        { id: 3, trait: "å’–å•¡ä¸­æ¯’", spd: 70, sta: 40, str: 80, color: "#00BCD4", desc: "é€Ÿåº¦éš¨æ©Ÿè·³å‹•ï¼Œå……æ»¿ä¸ç¢ºå®šæ€§" },
        { id: 4, trait: "ç”©é‹å°ˆå®¶", spd: 60, sta: 70, str: 40, color: "#FFEB3B", desc: "å…ç–«æ‰€æœ‰è² é¢æ¸›é€Ÿäº‹ä»¶" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

    // --- åˆå§‹åŒ– UI ---
    function init() {
        // æ¸²æŸ“ç™»å…¥æŒ‰éˆ•
        const grid = document.getElementById('login-grid');
        names.forEach(n => {
            const b = document.createElement('button');
            b.className = 'login-btn'; b.id = `user-${n}`; b.innerText = n;
            b.onclick = () => login(n);
            grid.appendChild(b);
        });

        // æ¸²æŸ“é¦¬åŒ¹å¡ç‰‡
        const hList = document.getElementById('horse-list');
        horseLibrary.forEach((h, i) => {
            const card = document.createElement('div');
            card.className = 'horse-card'; card.id = `hcard-${i}`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <b style="color:var(--gold); font-size:18px;">${h.trait}</b>
                    <span style="font-size:24px;">ğŸ</span>
                </div>
                <div class="stat-row"><span class="stat-label">æ•ˆç‡</span><div class="stat-bar-bg"><div class="stat-fill" style="width:${h.spd}%; background:var(--accent);"></div></div></div>
                <div class="stat-row"><span class="stat-label">çºŒèˆª</span><div class="stat-bar-bg"><div class="stat-fill" style="width:${h.sta}%; background:#4CAF50;"></div></div></div>
                <p style="margin:5px 0 0; font-size:12px; color:#888;">ç‰¹æŠ€ï¼š${h.desc}</p>
            `;
            card.onclick = () => selectHorse(i);
            hList.appendChild(card);
        });

        if(isAdmin) document.getElementById('admin-start').style.display = 'block';
        
        listenFirebase();
    }

    // --- Firebase å³æ™‚ç›£è½ (æ ¸å¿ƒåŒæ­¥å€) ---
    function listenFirebase() {
        // 1. ç›£è½ä½¿ç”¨è€…ç™»å…¥
        db.ref('users').on('value', snap => {
            const data = snap.val() || {};
            names.forEach(n => {
                const b = document.getElementById(`user-${n}`);
                if(data[n]) b.classList.add('taken');
            });
            if(data[myName]) {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-setup').style.display = 'block';
                document.getElementById('user-display').innerText = `ä½ å¥½ï¼Œ${myName}`;
            }
        });

        // 2. ç›£è½é¸é¦¬é–å®š
        db.ref('assignments').on('value', snap => {
            const data = snap.val() || {};
            document.querySelectorAll('.horse-card').forEach(c => c.classList.remove('selected', 'taken'));
            Object.entries(data).forEach(([u, hIdx]) => {
                if(u === myName) document.getElementById(`hcard-${hIdx}`).classList.add('selected');
                else document.getElementById(`hcard-${hIdx}`).classList.add('taken');
            });
        });

        // 3. ç›£è½æ¯”è³½åŒæ­¥åº§æ¨™ (æœ€é‡è¦çš„åŒæ­¥æ©Ÿåˆ¶)
        db.ref('raceData/positions').on('value', snap => {
            const positions = snap.val();
            if(!positions) return;
            
            // å¦‚æœæ¯”è³½æ²’åœ¨ç•«é¢ä¸Šï¼Œå¼·åˆ¶åˆ‡æ›
            if(document.getElementById('track').style.display === 'none') {
                switchToTrack(Object.keys(positions));
            }

            // æ›´æ–°é¦¬åŒ¹åº§æ¨™
            Object.entries(positions).forEach(([idx, pos]) => {
                const el = document.getElementById(`horse-box-${idx}`);
                if(el) el.style.left = `${pos}%`;
            });
        });

        // 4. ç›£è½æ’åçµæœ
        db.ref('raceData/results').on('value', snap => {
            const results = snap.val();
            if(results) showLeaderboard(results);
        });
    }

    function login(n) {
        myName = n;
        db.ref(`users/${n}`).set(true);
    }

    function selectHorse(i) {
        db.ref(`assignments/${myName}`).set(i);
    }

    function switchToTrack(ids) {
        document.getElementById('view-setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        const container = document.getElementById('lanes-container');
        container.innerHTML = '';
        
        db.ref('assignments').once('value', snap => {
            const assigns = snap.val();
            ids.forEach(idx => {
                const owner = Object.keys(assigns).find(u => assigns[u] == idx);
                const hData = horseLibrary[idx];
                const lane = document.createElement('div');
                lane.className = 'lane'; lane.style.height = `${100/ids.length}%`;
                lane.innerHTML = `
                    <div class="horse-sprite" id="horse-box-${idx}" style="left:0;">
                        <div style="font-size:10px; white-space:nowrap;">${owner}</div>
                        <div style="font-size:25px; color:${hData.color}">ğŸ</div>
                    </div>
                `;
                container.appendChild(lane);
            });
        });
    }

    // --- ç®¡ç†å“¡å¼•æ“ï¼šçµ±ä¸€è¨ˆç®—åº§æ¨™ ---
    document.getElementById('admin-start').onclick = () => {
        db.ref('assignments').once('value', snap => {
            const participants = snap.val() || {};
            const horseIds = Object.values(participants);
            const states = horseIds.map(id => ({ id, pos: 0, speed: 1 + Math.random(), finished: false }));
            
            let startTime = Date.now();
            const engine = setInterval(() => {
                const updates = {};
                let allFinished = true;

                states.forEach(s => {
                    if(!s.finished) {
                        // é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„æ ¹æ“š horseLibrary å±¬æ€§è¨ˆç®—çš„é‚è¼¯
                        s.pos += (Math.random() * 1.5); 
                        if(s.pos >= 90) { s.pos = 90; s.finished = true; }
                        else allFinished = false;
                    }
                    updates[s.id] = s.pos;
                });

                db.ref('raceData/positions').set(updates);

                if(allFinished) {
                    clearInterval(engine);
                    // æ ¹æ“šçµæŸæ™‚é–“æ’åºä¸¦å¯«å…¥çµæœ...
                    db.ref('raceData/results').set(states.map(s => ({ id: s.id, name: "çé …å¾…é ˜" })));
                }
            }, 100);
        });
    };

    function showLeaderboard(data) {
        const lb = document.getElementById('leaderboard');
        lb.style.display = 'block';
        // æ¸²æŸ“æ’è¡Œ...
    }

    init();
</script>
</body>
</html>
