<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --track-bg: #2c3e50; --success: #4caf50; --warning: #ffeb3b; --danger: #ff5252; --recover: #00bcd4; --sprint: #ff5722; }
        
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* ç®¡ç†å“¡å°ˆå±¬é¢æ¿ */
        #admin-panel { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.85); border: 2px solid var(--gold); padding: 15px; border-radius: 15px; z-index: 1000; display: none; min-width: 200px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .admin-stat { font-size: 14px; margin-bottom: 8px; color: var(--gold); }
        .admin-list { font-size: 12px; color: #ccc; max-height: 100px; overflow-y: auto; }

        /* æ‰‹æ©Ÿé©æ‡‰æ€§ä½ˆå±€ */
        .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        
        #user-login { background: #1e1e1e; padding: 20px; border-radius: 20px; text-align: center; z-index: 200; position: fixed; top: 50%; transform: translateY(-50%); width: 85%; max-width: 400px; border: 2px solid var(--gold); }
        .name-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .name-btn { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; -webkit-tap-highlight-color: transparent; }
        .name-btn.taken { opacity: 0.3; pointer-events: none; }
        .name-btn.me { background: var(--success); border-color: white; box-shadow: 0 0 10px var(--success); }

        /* é¸é¦¬å€å„ªåŒ– */
        .setup-area { background: #1e1e1e; padding: 15px; border-radius: 20px; width: 95vw; max-width: 1000px; border: 1px solid #444; display: none; overflow-y: auto; max-height: 85vh; margin-top: 10px; }
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        @media (max-width: 480px) { .horse-select-grid { grid-template-columns: repeat(2, 1fr); } }

        .horse-slot { background: #252525; padding: 12px; border-radius: 12px; border: 2px solid #333; cursor: pointer; position: relative; transition: 0.2s; }
        .horse-slot.my-pick { border-color: var(--success); background: #1b2e1b; }
        .horse-slot.occupied { opacity: 0.3; filter: grayscale(1); }
        .occupied-label { position: absolute; top: 40%; left: 0; width: 100%; background: var(--primary); font-size: 12px; text-align: center; transform: rotate(-15deg); }

        .stat-row { display: flex; align-items: center; margin-top: 3px; font-size: 10px; }
        .stat-label { width: 30px; color: #888; }
        .stat-bar { flex-grow: 1; height: 4px; background: #000; border-radius: 2px; }
        .stat-fill { height: 100%; background: var(--gold); }

        /* è³½é“å€ */
        .track-container { position: relative; width: 100vw; flex-grow: 1; background: var(--track-bg); display: none; overflow: hidden; }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); border-left: 2px solid var(--gold); }
        .lane { position: relative; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; }
        .horse-container { position: absolute; left: 5px; display: flex; align-items: center; transition: left 0.3s linear; }
        .horse-icon { font-size: 24px; transform: scaleX(-1); }
        
        /* æ’è¡Œæ¦œ */
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: white; color: #111; border-radius: 20px; padding: 20px; z-index: 1000; display: none; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .rank-item { padding: 12px; border-radius: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .rank-1 { background: linear-gradient(90deg, #fff9c4, #fff); border-left: 5px solid var(--gold); }
        .rank-2 { background: linear-gradient(90deg, #f5f5f5, #fff); border-left: 5px solid var(--silver); }
        .rank-3 { background: linear-gradient(90deg, #efebe9, #fff); border-left: 5px solid var(--bronze); }
    </style>
</head>
<body>

    <h3 style="margin: 10px; color: var(--gold); text-align: center;">ğŸ AIOT 2026 å°¾ç‰™è³½é¦¬</h3>

    <div id="user-login">
        <h2 style="color: var(--gold); margin: 0;">ç™»å…¥åƒè³½</h2>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <div id="picker-info" style="text-align:center; margin-bottom:10px; font-size:14px; color:var(--gold);"></div>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <div id="admin-panel">
        <div class="admin-stat" id="admin-ready-count">å·²å°±ç·’: 0/10</div>
        <div class="admin-list" id="admin-ready-list"></div>
        <button id="start-btn" style="width:100%; margin-top:10px; padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ğŸ é–‹å§‹æ¯”è³½</button>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%; display: flex; flex-direction: column;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="text-align:center; color: var(--primary); margin: 0 0 15px 0;">ğŸ† è‹±é›„æ¦œ</h2>
        <div id="leaderboard-list"></div>
        <button onclick="resetData()" style="width:100%; padding:12px; margin-top:15px; background: #333; color: white; border:none; border-radius: 8px;">é‡ç½®ç³»çµ±</button>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "æ“…é•·æ‘¸é­šç¯€çœé«”åŠ›ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 50, sta: 65, burst: 95, lck: 60}, desc: "æœ€å¾Œé—œé ­ç˜‹ç‹‚åŠ é€Ÿã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 80, lck: 30}, desc: "èµ·æ­¥æ¥µå¿«ä½†æ˜“æ–·é›»ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "ç©©å®šè¼¸å‡ºä¹‹ç‹ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 50}, desc: "ä¾è³´å’–å•¡å› çˆ†ç™¼ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "ç¥ç´šå¹¸é‹ï¼Œçµ•ä¸æ»‘å€’ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 60}, desc: "é»˜é»˜å‰é€²çš„é•·è·‘è€…ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 35, sta: 70, burst: 99, lck: 40}, desc: "å£“ç§’å®Œæˆä»»å‹™çš„å¥‡è¹Ÿã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 60}, desc: "æ°£å‹¢è¬éˆçš„çŸ­è·‘æ‰‹ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "å¹³è¡¡å°±æ˜¯æœ€å¼·æ­¦å™¨ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    const colors = ["#FF5252", "#FFD700", "#E040FB", "#00E676", "#2979FF", "#FF9100", "#40C4FF", "#FF1744", "#F4FF81", "#B2FF59"];
    let myName = localStorage.getItem('my_race_name') || "";
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];

    function init() {
        if (isAdmin) document.getElementById('admin-panel').style.display = 'block';
        
        const nameGrid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'name-btn'; btn.id = `name-${n}`; btn.innerText = n;
            btn.onclick = () => login(n);
            nameGrid.appendChild(btn);
        });

        const horseGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'horse-slot'; div.id = `slot-${i}`;
            div.innerHTML = `
                <div style="font-size:24px; transform: scaleX(-1);">ğŸ</div>
                <div style="font-weight:bold; color:var(--gold); font-size:14px;">${h.trait}</div>
                <div class="stat-group">
                    <div class="stat-row"><span class="stat-label">SPD</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.spd}%"></div></div></div>
                    <div class="stat-row"><span class="stat-label">LCK</span><div class="stat-bar"><div class="stat-fill" style="width:${h.stats.lck}%"></div></div></div>
                </div>
            `;
            div.onclick = () => selectHorse(i);
            horseGrid.appendChild(div);
        });
        listenFirebase();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            names.forEach(n => {
                const btn = document.getElementById(`name-${n}`);
                if (users[n]) {
                    btn.classList.add('taken');
                    if (n === myName) { btn.classList.add('me'); document.getElementById('user-login').style.display = 'none'; document.getElementById('setup').style.display = 'block'; }
                } else { btn.classList.remove('taken', 'me'); }
            });
        });

        db.ref('assignments').on('value', snap => {
            const assignments = snap.val() || {};
            const readyNames = Object.keys(assignments);
            if (isAdmin) {
                document.getElementById('admin-ready-count').innerText = `å·²å°±ç·’: ${readyNames.length}/${names.length}`;
                document.getElementById('admin-ready-list').innerText = readyNames.join(', ');
            }
            document.getElementById('picker-info').innerText = myName ? `ä½ å¥½ ${myName}ï¼Œè«‹é¸æ“‡é¦¬åŒ¹` : "";
            
            horseLibrary.forEach((_, i) => {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.remove('occupied', 'my-pick');
                const owner = Object.keys(assignments).find(name => assignments[name] === i);
                if (owner) {
                    if (owner === myName) slot.classList.add('my-pick');
                    else {
                        slot.classList.add('occupied');
                        if(!slot.querySelector('.occupied-label')){
                            const l = document.createElement('div'); l.className = 'occupied-label'; l.innerText = owner;
                            slot.appendChild(l);
                        }
                    }
                }
            });
        });

        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) startTheGame(state.seed, state.participants);
        });
    }

    function login(n) { myName = n; localStorage.setItem('my_race_name', n); db.ref(`users/${n}`).set(true); }
    function selectHorse(idx) { if (myName) db.ref(`assignments/${myName}`).set(idx); }
    function resetData() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { db.ref().set(null); localStorage.clear(); location.reload(); } }

    document.getElementById('start-btn').onclick = function() {
        db.ref('assignments').once('value', snap => {
            const participants = snap.val() || {};
            if (Object.keys(participants).length === 0) return alert("é‚„æ²’æœ‰äººé¸é¦¬ï¼");
            db.ref('gameState').set({ status: 'racing', seed: Math.random(), participants: participants });
        });
    };

    function startTheGame(seed, participants) {
        raceStarted = true;
        document.querySelectorAll('#setup, #user-login, #admin-panel').forEach(el => el.style.display = 'none');
        document.getElementById('track').style.display = 'block';

        const lanesBox = document.getElementById('lanes-box');
        const list = Object.keys(participants).map((name, idx) => ({ name, horseData: horseLibrary[participants[name]], color: colors[idx % colors.length] }));
        const hHeight = 100 / list.length;

        list.forEach(item => {
            const lane = document.createElement('div'); lane.className = 'lane'; lane.style.height = `${hHeight}%`;
            lane.innerHTML = `<div class="horse-container" id="horse-${item.horseData.id}"><div class="status-bubble" id="status-${item.horseData.id}"></div><div class="horse-icon" style="color:${item.color}">ğŸ</div><div style="font-size:10px;">${item.name}</div></div>`;
            lanesBox.appendChild(lane);
        });
        runRaceEngine(seed, list);
    }

    function runRaceEngine(seed, list) {
        let seedVal = seed;
        const syncRand = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };
        const horses = list.map(item => ({ ...item.horseData, ownerName: item.name, pos: 10, speed: 0, currStamina: 100, finished: false, isStalled: false, lastEvent: 0 }));
        const finishLine = document.getElementById('track').offsetWidth - 80;

        const timer = setInterval(() => {
            horses.forEach(h => {
                if (h.finished) return;
                if (!h.isStalled) {
                    h.speed = (h.speed * 0.95) + (syncRand() * 0.25) + (h.stats.spd * 0.002);
                    h.pos += h.speed;
                }
                document.getElementById(`horse-${h.id}`).style.left = h.pos + 'px';
                if (h.pos >= finishLine) { h.finished = true; finishedHorses.push(h); if (finishedHorses.length === horses.length) { clearInterval(timer); showLeaderboard(); } }
            });
        }, 50);
    }

    function showLeaderboard() {
        document.getElementById('leaderboard').style.display = 'block';
        const listEl = document.getElementById('leaderboard-list');
        listEl.innerHTML = "";
        finishedHorses.forEach((h, i) => {
            const rank = i + 1;
            const item = document.createElement('div');
            item.className = `rank-item rank-${rank <= 3 ? rank : 'other'}`;
            let prize = rank === 1 ? "$2500" : (rank <= 5 ? "ç¦®åˆ¸ $1000" : (rank === 6 ? "$500" : (rank === 7 ? "$400" : (rank === 8 ? "$300" : (rank === 9 ? "$200" : "$100")))));
            item.innerHTML = `<span>#${rank} ${h.ownerName}</span><span style="color:var(--primary)">${prize}</span>`;
            listEl.appendChild(item);
        });
    }

    init();
</script>
</body>
</html>
