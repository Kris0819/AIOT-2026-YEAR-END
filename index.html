<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å°ˆæ¥­ç›£æ§ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --track-bg: #1a1a1a; 
            --success: #4caf50; --danger: #ff5252; --warning: #ffb300; --sprint: #6200ea;
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #121212; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ç®¡ç†å“¡ç›£æ§é¢æ¿ */
        #admin-monitor { position: fixed; top: 0; left: 0; width: 100%; background: #2c3e50; padding: 10px; z-index: 9999; display: none; border-bottom: 2px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .monitor-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .user-tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; background: #444; border: 1px solid #666; }
        .user-tag.ready { background: var(--success); border-color: white; color: white; box-shadow: 0 0 5px var(--success); }
        .admin-controls { display: flex; justify-content: center; gap: 20px; }
        .control-btn { padding: 8px 25px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-start { background: var(--success); color: white; font-size: 16px; }
        .btn-reset { background: var(--danger); color: white; }

        /* é¸é¦¬ä»‹é¢å„ªåŒ– */
        .setup-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: none; }
        .horse-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .horse-card { background: #222; border: 2px solid #444; border-radius: 15px; padding: 15px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .horse-card:hover { border-color: var(--gold); transform: translateY(-3px); }
        .horse-card.my-pick { border-color: var(--success); background: #1a2e1a; }
        .horse-card.occupied { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .horse-header { display: flex; justify-content: space-between; align-items: center; }
        .horse-id { background: var(--gold); color: black; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .horse-desc { font-size: 13px; color: #aaa; margin: 10px 0; font-style: italic; line-height: 1.4; }
        .stat-bar-bg { height: 8px; background: #333; border-radius: 4px; margin: 5px 0; overflow: hidden; }
        .stat-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #f39c12); }

        /* è³½é“ç³»çµ± */
        .track-container { position: relative; width: 96vw; flex-grow: 1; background: var(--track-bg); border: 2px solid #333; border-radius: 10px; display: none; margin: 10px auto; }
        .finish-line { position: absolute; right: 60px; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); z-index: 1; }
        .lane { position: relative; border-bottom: 1px solid rgba(255,255,255,0.05); height: 10%; display: flex; align-items: center; }
        .horse-runner { position: absolute; left: 0; transition: left 0.05s linear; z-index: 10; display: flex; align-items: center; width: 120px; }
        .horse-emoji { font-size: 30px; transform: scaleX(-1); }
        .runner-info { margin-left: 5px; }
        .stamina-container { width: 50px; height: 5px; background: #000; border: 1px solid #555; margin-top: 2px; }
        .stamina-bar { height: 100%; background: var(--success); width: 100%; }
        .status-bubble { position: absolute; top: -35px; left: 0; padding: 4px 8px; background: var(--danger); border-radius: 8px; font-size: 11px; font-weight: bold; white-space: nowrap; display: none; z-index: 20; }

        /* æ’è¡Œæ¦œ */
        #leaderboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: white; color: #222; border-radius: 20px; padding: 25px; display: none; z-index: 1000; text-align: center; }
        .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; font-weight: 800; }

        #user-login { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: #1e1e1e; padding: 30px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; z-index: 500; }
    </style>
</head>
<body>

    <div id="admin-monitor">
        <div class="monitor-grid" id="monitor-list"></div>
        <div class="admin-controls">
            <button class="control-btn btn-reset" onclick="resetGame()">â™»ï¸ é‡ç½®</button>
            <button class="control-btn btn-start" onclick="triggerRace()">ğŸš€ å…¨å“¡é–‹è³½</button>
        </div>
    </div>

    <div id="user-login">
        <h2 style="color: var(--gold); margin-top:0;">ğŸ AIOT 2026 è³½é¦¬</h2>
        <p>è«‹é¸æ“‡æ‚¨çš„èº«åˆ†ä»¥é€²å…¥é¦¬å ´</p>
        <div class="name-grid" id="name-grid"></div>
    </div>

    <div id="setup" class="setup-area">
        <h2 style="text-align: center; color: var(--gold);">ğŸ† é¸æ“‡æ‚¨çš„æˆ°é¦¬</h2>
        <div class="horse-select-grid" id="select-grid"></div>
    </div>

    <div class="track-container" id="track">
        <div class="finish-line"></div>
        <div id="lanes-box" style="height: 100%;"></div>
    </div>

    <div id="leaderboard">
        <h2 style="margin:0; color:var(--primary)">ğŸ è³½äº‹çµæŸ ğŸ</h2>
        <div id="leader-list" style="margin: 20px 0;"></div>
        <button class="control-btn btn-reset" style="width:100%" onclick="resetGame()">ä¸‹ä¸€å±€</button>
    </div>

    <audio id="audio-lobby" loop src="https://actions.google.com/config/promo/sdk/v1/sample_audio/gameloop.m4a"></audio>
    <audio id="audio-race" loop src="https://actions.google.com/config/promo/sdk/v1/sample_audio/sport_stadium_crowd_cheer.mp3"></audio>
    <audio id="audio-gun" src="https://www.soundjay.com/misc/sounds/starting-pistol-1.mp3"></audio>

<script>
    // --- 1. Firebase é…ç½® ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. æˆ°é¦¬åº« ---
    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", spd: 0.65, sta: 0.95, desc: "æ“…é•·åœ¨æœƒè­°ä¸­ç¥éš±ï¼Œé«”åŠ›ä¿ç•™æ¥µä½³ï¼Œå¾ä¸çˆ†è‚ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", spd: 0.55, sta: 0.65, desc: "æ¥è¿‘çµ‚é»æ™‚æœƒè§¸ç™¼ã€æ‰“å¡ Zoneã€ï¼Œé€Ÿåº¦ç¬é–“é£†å‡ã€‚" },
        { id: 2, trait: "è‚è‹¦çˆ†è‚ç‹", spd: 0.98, sta: 0.20, desc: "èµ·æ­¥æ¥µå¿«ï¼Œä½†é«”åŠ›æ¶ˆè€—æ¥µé€Ÿï¼Œéš¨æ™‚æº–å‚™åŸåœ°å¾€ç”Ÿã€‚" },
        { id: 3, trait: "å˜´ç ²PM", spd: 0.75, sta: 0.60, desc: "è·‘å¾—ä¸ä¸€å®šå¿«ï¼Œä½†æ‘”å€’æ™‚æœƒæŠŠé‹ç”©çµ¦åˆ¥äººï¼Œå—å‚·è¼ƒè¼•ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", spd: 0.85, sta: 0.40, desc: "è¡€æ¶²è£¡éƒ½æ˜¯é˜¿æ‹‰æ¯”å¡ï¼Œæƒ…ç·’è·Ÿé€Ÿåº¦ä¸€æ¨£ä¸ç©©å®šã€‚" },
        { id: 5, trait: "é‚Šç·£å·¥ç¨‹å¸«", spd: 0.60, sta: 0.85, desc: "å­˜åœ¨æ„Ÿæ¥µä½ï¼Œæ²’äººç™¼ç¾ä»–é»˜é»˜åœ°çˆ¬åˆ°äº†å‰é¢ã€‚" }
    ];

    let names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let raceStarted = false;
    let finishedHorses = [];

    // --- 3. åˆå§‹åŒ– ---
    function init() {
        if (isAdmin) document.getElementById('admin-monitor').style.display = 'block';
        
        // æ¸²æŸ“åå­—é¸å–®
        const grid = document.getElementById('name-grid');
        names.forEach(n => {
            const btn = document.createElement('button'); btn.className = 'monitor-btn control-btn'; btn.id = `btn-${n}`;
            btn.style.background = '#333'; btn.style.color = '#fff'; btn.style.margin = '5px'; btn.innerText = n;
            btn.onclick = () => login(n);
            grid.appendChild(btn);
        });

        // æ¸²æŸ“é¸é¦¬å¡ç‰‡
        const hGrid = document.getElementById('select-grid');
        horseLibrary.forEach((h, i) => {
            const card = document.createElement('div'); card.className = 'horse-card'; card.id = `card-${i}`;
            card.innerHTML = `
                <div class="horse-header"><span class="horse-id">#${i+1}</span> <b>${h.trait}</b></div>
                <div class="horse-desc">${h.desc}</div>
                <div style="font-size:11px; color:var(--gold)">é€Ÿåº¦æ½›åŠ›</div>
                <div class="stat-bar-bg"><div class="stat-fill" style="width:${h.spd*100}%"></div></div>
                <div style="font-size:11px; color:var(--success)">çºŒèˆªèƒ½åŠ›</div>
                <div class="stat-bar-bg"><div class="stat-fill" style="width:${h.sta*100}%"></div></div>
            `;
            card.onclick = () => selectHorse(i);
            hGrid.appendChild(card);
        });

        listenFirebase();
    }

    function login(n) {
        myName = n;
        db.ref(`users/${n}`).set({ name: n, status: 'online', horse: -1 });
        document.getElementById('audio-lobby').play();
    }

    function selectHorse(idx) {
        if (!myName) return;
        db.ref(`users/${myName}/horse`).set(idx);
    }

    function listenFirebase() {
        // ç›£æ§æ‰€æœ‰ç©å®¶ç‹€æ…‹
        db.ref('users').on('value', snap => {
            const users = snap.val() || {};
            const monitor = document.getElementById('monitor-list');
            if (isAdmin) monitor.innerHTML = "";

            names.forEach(n => {
                const data = users[n];
                // ç™»å…¥ä»‹é¢ç½®ç°
                const btn = document.getElementById(`btn-${n}`);
                if (data) btn.style.opacity = "0.3";

                // ç®¡ç†å“¡ç›£æ§
                if (isAdmin) {
                    const tag = document.createElement('div'); tag.className = `user-tag ${data && data.horse !== -1 ? 'ready' : ''}`;
                    tag.innerText = `${n} ${data && data.horse !== -1 ? 'âœ…' : 'ğŸ”´'}`;
                    monitor.appendChild(tag);
                }

                // è‡ªå·±çš„ä»‹é¢åˆ‡æ›
                if (n === myName && data) {
                    document.getElementById('user-login').style.display = 'none';
                    document.getElementById('setup').style.display = 'block';
                }
            });

            // é¸é¦¬å¡ç‰‡é–å®š
            const assigns = Object.values(users).filter(u => u.horse !== -1);
            horseLibrary.forEach((_, i) => {
                const card = document.getElementById(`card-${i}`);
                card.classList.remove('occupied', 'my-pick');
                const owner = Object.values(users).find(u => u.horse === i);
                if (owner) {
                    if (owner.name === myName) card.classList.add('my-pick');
                    else card.classList.add('occupied');
                }
            });
        });

        // ç›£æ§è³½äº‹é–‹å§‹
        db.ref('gameState').on('value', snap => {
            const state = snap.val();
            if (state && state.status === 'racing' && !raceStarted) {
                db.ref('users').once('value', uSnap => {
                    startRace(state.seed, uSnap.val());
                });
            }
            if (!state && raceStarted) location.reload();
        });
    }

    function triggerRace() {
        db.ref('gameState').set({ status: 'racing', seed: Math.random() });
    }

    function resetGame() {
        db.ref().set(null);
        location.reload();
    }

    // --- 4. è³½é¦¬åŒæ­¥å¼•æ“ ---
    function startRace(seed, allUsers) {
        raceStarted = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('track').style.display = 'block';
        document.getElementById('audio-lobby').pause();
        document.getElementById('audio-gun').play();
        document.getElementById('audio-race').play();

        const participants = Object.values(allUsers).filter(u => u.horse !== -1);
        const lanesBox = document.getElementById('lanes-box');
        lanesBox.innerHTML = "";

        participants.forEach(p => {
            const lane = document.createElement('div'); lane.className = 'lane';
            lane.innerHTML = `
                <div class="horse-runner" id="run-${p.horse}">
                    <div class="status-bubble" id="bubble-${p.horse}"></div>
                    <div class="horse-emoji">ğŸ</div>
                    <div class="runner-info">
                        <div style="font-size:10px; font-weight:bold;">${p.name}</div>
                        <div class="stamina-container"><div class="stamina-bar" id="sta-${p.horse}"></div></div>
                    </div>
                </div>`;
            lanesBox.appendChild(lane);
        });

        const VIRTUAL_FINISH = 1000;
        let seedVal = seed * 1000000;
        const syncRand = () => { seedVal = (seedVal * 9301 + 49297) % 233280; return seedVal / 233280; };
        
        const runners = participants.map(p => ({
            ...horseLibrary[p.horse],
            owner: p.name,
            v_pos: 0,
            speed: 0,
            stamina: 100,
            isStalled: false,
            stallEnd: 0,
            finished: false
        }));

        let frame = 0;
        const mainLoop = setInterval(() => {
            frame++;
            const trackWidth = document.getElementById('track').offsetWidth - 130;

            runners.forEach(h => {
                if (h.finished) return;

                // é«”åŠ›èˆ‡æ¢å¾©é‚è¼¯
                if (h.isStalled) {
                    if (frame >= h.stallEnd) { 
                        h.isStalled = false; h.stamina = 80; 
                        document.getElementById(`bubble-${h.id}`).style.display = 'none';
                    }
                } else {
                    // æ­£å¸¸å¥”è·‘é«”åŠ›æ¶ˆè€—
                    let drain = (h.speed * 0.1) + 0.05;
                    h.stamina = Math.max(0, h.stamina - drain);
                    
                    if (h.stamina <= 0) {
                        h.isStalled = true;
                        h.speed = 0;
                        h.stallEnd = frame + 100; // ä¼‘æ¯ 5 ç§’ (50ms * 100)
                        const bubble = document.getElementById(`bubble-${h.id}`);
                        bubble.innerText = "ğŸ¤® çˆ†è‚ä¼‘æ¯ä¸­..."; bubble.style.display = 'block';
                    }
                }

                // é€Ÿåº¦è¨ˆç®—
                if (!h.isStalled) {
                    let acc = syncRand() * 0.2;
                    // ç‰¹æ®Šäº‹ä»¶ (åŒæ­¥éš¨æ©Ÿ)
                    if (frame % 60 === 0) {
                        const eventRnd = syncRand();
                        if (eventRnd < 0.03) { // æ»‘å€’
                            h.v_pos = Math.max(0, h.v_pos - 60);
                            showTempBubble(h.id, "â›¸ï¸ è¢«ç”©é‹çµ†å€’ï¼", 30);
                        } else if (eventRnd > 0.97) { // è¡åˆº
                            h.speed += 5;
                            showTempBubble(h.id, "ğŸš€ æˆªç¨¿è¡åˆºï¼", 30);
                        }
                    }

                    // é«”åŠ›ä½è½é™é€Ÿ
                    let staminaMult = h.stamina < 30 ? 0.6 : 1.0;
                    h.speed = (h.speed * 0.93) + acc + (h.spd * 0.15 * staminaMult);
                    h.v_pos += h.speed;
                }

                // UI æ›´æ–°
                const realX = (h.v_pos / VIRTUAL_FINISH) * trackWidth;
                const el = document.getElementById(`run-${h.id}`);
                el.style.left = Math.min(realX, trackWidth + 60) + 'px';
                document.getElementById(`sta-${h.id}`).style.width = h.stamina + '%';

                // åˆ°é”çµ‚é»
                if (h.v_pos >= VIRTUAL_FINISH && !h.finished) {
                    h.finished = true;
                    finishedHorses.push(h);
                    if (finishedHorses.length === runners.length) {
                        clearInterval(mainLoop);
                        renderLeaderboard();
                    }
                }
            });
        }, 50);
    }

    function showTempBubble(id, text, frames) {
        const b = document.getElementById(`bubble-${id}`);
        b.innerText = text; b.style.display = 'block';
        setTimeout(() => { if(!horseLibrary[id].isStalled) b.style.display = 'none'; }, frames * 50);
    }

    function renderLeaderboard() {
        document.getElementById('audio-race').pause();
        document.getElementById('leaderboard').style.display = 'block';
        const list = document.getElementById('leader-list');
        list.innerHTML = finishedHorses.map((h, i) => `
            <div class="rank-item">
                <span>#${i+1} ${h.owner}</span>
                <span style="color:#777; font-size:12px;">(${h.trait})</span>
            </div>
        `).join('');
    }

    init();
</script>
</body>
</html>
