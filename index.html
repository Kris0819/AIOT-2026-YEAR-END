<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AIOT å°¾ç‰™è³½é¦¬ - å…¨é«”é©—å¢å¼·ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #ffd700; --success: #4caf50; 
            --danger: #ff5252; --sprint: #ff5722; --recover: #2196f3;
            --bg-dark: #121212;
        }

        body { font-family: 'PingFang TC', sans-serif; background: #000; color: white; margin: 0; padding: 0; height: 100vh; overflow: hidden; }

        /* é é¢ç®¡ç† */
        .page { display: none; height: 100vh; width: 100vw; position: absolute; flex-direction: column; }
        .page.active { display: flex; }

        /* Header */
        .header-bar { background: #222; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; height: 50px; z-index: 100; }
        .user-tag { background: rgba(255,215,0,0.1); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--gold); color: var(--gold); font-size: 14px; font-weight: bold; }

        /* 1. é¸äººç•«é¢ (å›æ­¸ç²¾ç·»ç‰ˆ) */
        #page-login { background: radial-gradient(circle, #222 0%, #000 100%); align-items: center; justify-content: center; }
        .login-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 85%; max-width: 450px; }
        .name-card { 
            padding: 20px; background: #2a2a2a; border: 1px solid #444; border-radius: 15px; 
            text-align: center; font-weight: bold; font-size: 18px; color: #fff;
            transition: 0.3s; cursor: pointer; position: relative; overflow: hidden;
        }
        .name-card:active { transform: scale(0.95); background: #333; }
        .name-card.taken { opacity: 0.2; filter: grayscale(1); pointer-events: none; border-color: #222; }
        .name-card.taken::after { content: "å·²ç™»å…¥"; position: absolute; bottom: 5px; right: 10px; font-size: 10px; color: #666; }

        /* 2. é¸é¦¬ç•«é¢ */
        #page-setup { background: var(--bg-dark); overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .horse-card { 
            background: #1e1e1e; border-radius: 18px; padding: 18px; border: 2px solid #333; 
            margin-bottom: 15px; transition: 0.3s;
        }
        .horse-card.selected { border-color: var(--success); background: #1a2e1a; }
        .horse-card.occupied { opacity: 0.3; pointer-events: none; }
        .stat-bar-bg { height: 6px; background: #000; border-radius: 3px; overflow: hidden; margin-top: 3px; }
        .stat-bar-fill { height: 100%; background: linear-gradient(90deg, #444, var(--gold)); }

        /* 3. æ¯”è³½ç•«é¢ */
        #page-track { background: #1a1a1a; }
        .race-container { flex-grow: 1; position: relative; background: repeating-linear-gradient(90deg, transparent, transparent 49px, #222 50px); }
        .lane { position: relative; border-bottom: 2px solid #333; width: 100%; display: flex; align-items: center; }
        
        /* é¦¬åŒ¹è·‘æ­¥å‹•ç•« */
        .horse-pawn { position: absolute; left: 0; display: flex; align-items: center; width: 140px; will-change: left; }
        .horse-visual { 
            font-size: 40px; transform: scaleX(-1); 
            animation: gallop 0.4s infinite ease-in-out; /* åŸºç¤è·‘æ­¥éœ‡å‹• */
        }
        .horse-visual.sprinting { animation-duration: 0.2s; } /* è¡åˆºæ™‚éœ‡å‹•åŠ å¿« */
        .horse-visual.recovering { animation: none; opacity: 0.6; filter: grayscale(1); } /* çˆ†è‚åœæ­¢éœ‡å‹• */

        @keyframes gallop {
            0%, 100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
            50% { transform: scaleX(-1) translateY(-8px) rotate(-5deg); }
        }

        .stamina-ui { width: 60px; margin-left: 10px; }
        .stamina-inner { height: 5px; background: var(--success); border-radius: 3px; transition: width 0.3s; }

        .bubble { position: absolute; top: -45px; left: 0; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: 2px solid #fff; z-index: 50; }
        .timer-text { position: absolute; top: -25px; left: 0; color: var(--recover); font-weight: bold; font-size: 14px; }
        
        /* çµ‚é»ç·š */
        .finish-line { 
            position: absolute; right: 80px; top: 0; bottom: 0; width: 30px; 
            background: repeating-linear-gradient(0deg, #fff, #fff 15px, #000 15px, #000 30px); 
            border-left: 4px solid var(--gold); box-shadow: -5px 0 15px rgba(255,215,0,0.3);
        }

        /* éŸ³æ¨‚æ§åˆ¶ */
        .music-ctrl { position: fixed; top: 10px; right: 10px; z-index: 200; background: rgba(0,0,0,0.5); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* 4. æ’è¡Œæ¦œ */
        #leaderboard-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .lb-box { background: white; color: #111; width: 85%; border-radius: 25px; padding: 30px; text-align: center; }
    </style>
</head>
<body>

<audio id="bgm" loop src="https://assets.mixkit.co/music/preview/mixkit-fast-game-action-loop-460.mp3"></audio>
<div class="music-ctrl" onclick="toggleMusic()">ğŸµ</div>

<div class="header-bar" id="ui-header" style="display:none;">
    <div class="user-tag">ğŸ‘¤ <span id="label-user-name"></span></div>
    <button style="background:none; border:none; color:#888; text-decoration:underline;" onclick="logout()">åˆ‡æ›</button>
</div>

<div id="page-login" class="page active">
    <h2 style="color:var(--gold); margin-bottom:5px; letter-spacing:2px;">AIOT 2026 å°¾ç‰™è³½é¦¬</h2>
    <p style="color:#666; margin-bottom:30px;">è«‹é»æ“Šå§“åç™»å…¥åƒèˆ‡</p>
    <div class="login-grid" id="login-grid"></div>
</div>

<div id="page-setup" class="page">
    <h3 style="text-align:center; color:var(--gold);">ğŸ é¸æ“‡ä½ çš„ç«¶è³½é¦¬åŒ¹</h3>
    <div class="horse-list" id="horse-selection-list"></div>
</div>

<div id="page-track" class="page">
    <div class="race-container">
        <div class="finish-line"></div>
        <div id="lanes-render-area" style="height:100%;"></div>
    </div>
</div>

<div id="leaderboard-overlay">
    <div class="lb-box">
        <h1 style="color:var(--primary); margin:0;">ğŸ† Final Results</h1>
        <div id="rankings-list" style="margin:20px 0;"></div>
        <button id="admin-reset-btn" onclick="adminReset()" style="display:none; width:100%; padding:15px; background:#111; color:white; border-radius:15px; font-weight:bold; border:none; cursor:pointer;">é‡ç½®ä¸¦é–‹å§‹æ–°ä¸€è¼ª</button>
        <p id="msg-wait" style="font-size:12px; color:#888;">è«‹ç­‰å¾…ç®¡ç†è€…é‡ç½®éŠæˆ²</p>
    </div>
</div>

<div id="admin-panel" style="position:fixed; bottom:20px; left:0; right:0; display:none; justify-content:center; gap:10px; z-index:9999;">
    <button onclick="adminStart()" style="padding:12px 30px; background:var(--success); color:white; border-radius:30px; border:none; font-weight:bold; box-shadow:0 4px 15px rgba(0,0,0,0.4);">ğŸ é–‹å§‹æ¯”è³½</button>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBHJtwI42b8i6z7zRw6tDgtR4ITSNKWrf8",
      authDomain: "aiot-d53dc.firebaseapp.com",
      databaseURL: "https://aiot-d53dc-default-rtdb.firebaseio.com",
      projectId: "aiot-d53dc",
      storageBucket: "aiot-d53dc.firebasestorage.app",
      messagingSenderId: "1021331253049",
      appId: "1:1021331253049:web:11f0695e8ab64eae0baae8",
      measurementId: "G-9YDKS70ZE7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const horseLibrary = [
        { id: 0, trait: "è–ªæ°´å°å·", stats: {spd: 60, sta: 95, burst: 40, lck: 70}, desc: "é«”åŠ›æ·±ä¸å¯æ¸¬ï¼Œç©©ç´®ç©©æ‰“ã€‚" },
        { id: 1, trait: "ä¸‹ç­æˆ°ç¥", stats: {spd: 55, sta: 65, burst: 95, lck: 60}, desc: "æœ€å¾Œè¡åˆºéšæ®µç„¡äººèƒ½æ•µã€‚" },
        { id: 2, trait: "çˆ†è‚ç‹", stats: {spd: 95, sta: 25, burst: 85, lck: 30}, desc: "é€Ÿåº¦æ¥µå¿«ä½†é«”åŠ›æ¥µä½ã€‚" },
        { id: 3, trait: "æœƒè­°ç™¼è¨€æ©Ÿ", stats: {spd: 75, sta: 60, burst: 60, lck: 80}, desc: "é »ç‡ç©©å®šï¼Œé©åˆå„ç¨®è³½é“ã€‚" },
        { id: 4, trait: "å’–å•¡ä¸­æ¯’è€…", stats: {spd: 80, sta: 45, burst: 75, lck: 55}, desc: "çˆ†ç™¼åŠ›å¼·ï¼Œä½†é«”åŠ›æ¶ˆè€—å¿«ã€‚" },
        { id: 5, trait: "ç”©é‹å°ˆæ¥­æˆ¶", stats: {spd: 45, sta: 85, burst: 30, lck: 99}, desc: "å¹¸é‹é»æ»¿ï¼Œçµ•å°ä¸æœƒè·Œå€’ã€‚" },
        { id: 6, trait: "åŠ ç­é‚Šç·£äºº", stats: {spd: 55, sta: 90, burst: 50, lck: 65}, desc: "é»˜é»˜è€•è€˜çš„è€åŠ›å‹é¦¬åŒ¹ã€‚" },
        { id: 7, trait: "æˆªç¨¿è¡åˆº", stats: {spd: 40, sta: 70, burst: 99, lck: 40}, desc: "è¶Šæ¥è¿‘çµ‚é»é€Ÿåº¦è¶Šå¿«ã€‚" },
        { id: 8, trait: "å‡ºä¸€å¼µå˜´", stats: {spd: 85, sta: 50, burst: 70, lck: 65}, desc: "ç”¨æ°£å‹¢åœ¨è·‘æ­¥çš„é¸æ‰‹ã€‚" },
        { id: 9, trait: "ä¸­åº¸ä¹‹é“", stats: {spd: 70, sta: 75, burst: 65, lck: 70}, desc: "å„é …æŒ‡æ¨™æœ€å¹³è¡¡çš„é¸æ“‡ã€‚" }
    ];

    const names = ["JULIA", "MOLLY", "DON", "è±ªå“¥", "Gimme", "Erick", "éŸ‹å¿—", "JULI", "JASON", "KRIS"];
    let myName = localStorage.getItem('race_user') || "";
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';
    let serverOffset = 0;
    let musicStarted = false;

    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val());

    function init() {
        if (isAdmin) {
            document.getElementById('admin-panel').style.display = 'flex';
            document.getElementById('admin-reset-btn').style.display = 'block';
            document.getElementById('msg-wait').style.display = 'none';
        }

        const loginGrid = document.getElementById('login-grid');
        names.forEach(n => {
            const d = document.createElement('div');
            d.className = 'name-card';
            d.id = `user-${n}`;
            d.innerText = n;
            d.onclick = () => { login(n); };
            loginGrid.appendChild(d);
        });

        const setupGrid = document.getElementById('horse-selection-list');
        horseLibrary.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = 'horse-card';
            d.id = `slot-${i}`;
            d.innerHTML = `
                <div style="font-weight:bold; color:var(--gold); font-size:18px;">${h.trait}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:10px 0;">
                    <div>é€Ÿåº¦ <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${h.stats.spd}%"></div></div></div>
                    <div>é«”åŠ› <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${h.stats.sta}%"></div></div></div>
                </div>
                <div style="font-size:12px; color:#aaa;">${h.desc}</div>
            `;
            d.onclick = () => { if(myName) db.ref(`assignments/${myName}`).set(i); };
            setupGrid.appendChild(d);
        });

        listenFirebase();
    }

    function toggleMusic() {
        const bgm = document.getElementById('bgm');
        if (bgm.paused) { bgm.play(); } else { bgm.pause(); }
    }

    function login(n) {
        if (!musicStarted) { document.getElementById('bgm').play(); musicStarted = true; }
        myName = n;
        localStorage.setItem('race_user', n);
        db.ref(`users/${n}`).set(true);
    }

    function logout() {
        if(myName) { db.ref(`users/${myName}`).remove(); db.ref(`assignments/${myName}`).remove(); }
        localStorage.removeItem('race_user');
        location.reload();
    }

    function listenFirebase() {
        db.ref('users').on('value', snap => {
            const u = snap.val() || {};
            names.forEach(n => {
                const el = document.getElementById(`user-${n}`);
                u[n] ? el.classList.add('taken') : el.classList.remove('taken');
            });
            if (myName && u[myName]) {
                document.getElementById('page-login').classList.remove('active');
                document.getElementById('page-setup').classList.add('active');
                document.getElementById('ui-header').style.display = 'flex';
                document.getElementById('label-user-name').innerText = myName;
            } else {
                document.getElementById('page-login').classList.add('active');
                document.getElementById('page-setup').classList.remove('active');
                document.getElementById('ui-header').style.display = 'none';
            }
        });

        db.ref('assignments').on('value', snap => {
            const a = snap.val() || {};
            horseLibrary.forEach((_, i) => {
                const el = document.getElementById(`slot-${i}`);
                const owner = Object.keys(a).find(k => a[k] === i);
                el.className = 'horse-card';
                if (owner === myName) el.classList.add('selected');
                else if (owner) el.classList.add('occupied');
            });
        });

        db.ref('gameState').on('value', snap => {
            const s = snap.val();
            if (s && s.status === 'racing') runRace(s);
            if (s && s.status === 'idle' && document.getElementById('page-track').classList.contains('active')) location.reload();
        });
    }

    function adminStart() {
        db.ref('assignments').once('value', snap => {
            const players = snap.val();
            if (!players) return alert("æ²’äººé¸é¦¬ï¼");
            const raceData = {};
            Object.entries(players).forEach(([name, hIdx]) => {
                const h = horseLibrary[hIdx];
                const events = [];
                for(let j=0; j<3; j++) {
                    const t = 8 + (j * 8) + Math.random() * 5;
                    const type = (Math.random() * 100 < h.stats.lck) ? 'burst' : 'slip';
                    events.push({ t, type });
                }
                raceData[name] = { hIdx, events };
            });
            db.ref('gameState').set({ status: 'racing', startTime: Date.now() + serverOffset + 3000, raceData });
        });
    }

    function adminReset() { db.ref().set({ gameState: { status: 'idle' } }); }

    function runRace(state) {
        document.getElementById('page-setup').classList.remove('active');
        document.getElementById('page-track').classList.add('active');
        document.getElementById('ui-header').style.display = 'none';
        
        const renderArea = document.getElementById('lanes-render-area');
        renderArea.innerHTML = "";
        
        const players = Object.entries(state.raceData);
        const laneH = 100 / Math.max(players.length, 5);
        
        players.forEach(([name, data], idx) => {
            const div = document.createElement('div');
            div.className = 'lane';
            div.style.height = `${laneH}%`;
            div.innerHTML = `
                <div class="horse-pawn" id="pawn-${idx}">
                    <div class="bubble" id="bub-${idx}" style="display:none;"></div>
                    <div class="timer-text" id="time-${idx}"></div>
                    <div class="horse-visual" id="vis-${idx}">ğŸ</div>
                    <div class="stamina-ui">
                        <div style="font-size:10px; margin-bottom:2px;">${name}</div>
                        <div style="background:#000; height:5px; border-radius:3px;">
                            <div class="stamina-inner" id="stam-${idx}" style="width:100%;"></div>
                        </div>
                    </div>
                </div>
            `;
            renderArea.appendChild(div);
        });

        const finishX = renderArea.offsetWidth - 140;
        const runners = players.map(([name, data]) => ({
            name, stats: horseLibrary[data.hIdx].stats, events: data.events,
            progress: 0, stamina: 100, isRecovering: false, recoveryEndTime: 0, finished: false
        }));

        let lastTime = Date.now() + serverOffset;

        function frame() {
            const now = Date.now() + serverOffset;
            const dt = (now - lastTime) / 1000;
            lastTime = now;
            const elapsed = (now - state.startTime) / 1000;

            if (elapsed < 0) { requestAnimationFrame(frame); return; }

            runners.forEach((r, i) => {
                if (r.finished) return;
                const el = document.getElementById(`pawn-${i}`);
                const vis = document.getElementById(`vis-${i}`);
                const bub = document.getElementById(`bub-${i}`);
                const stam = document.getElementById(`stam-${i}`);
                const timer = document.getElementById(`time-${i}`);

                if (r.isRecovering) {
                    vis.classList.add('recovering');
                    const left = Math.ceil(r.recoveryEndTime - elapsed);
                    timer.innerText = left > 0 ? `ğŸ¤® çˆ†è‚ä¸­..${left}s` : "";
                    if (elapsed >= r.recoveryEndTime) { r.isRecovering = false; r.stamina = 100; timer.innerText = ""; vis.classList.remove('recovering'); }
                } else {
                    let currentSpd = (r.stats.spd / 100) * 0.035; 
                    let drain = (1.5 - r.stats.sta/100) * 2.5;
                    let eventType = null;

                    r.events.forEach(ev => {
                        if (elapsed >= ev.t && elapsed <= ev.t + 1.5) {
                            if (ev.type === 'burst') { 
                                currentSpd *= (1.5 + r.stats.burst/100); 
                                drain *= 5; eventType = "âš¡ è¡åˆºï¼"; vis.classList.add('sprinting');
                            } else { 
                                r.progress = Math.max(0, r.progress - 0.012 * dt);
                                eventType = "â›¸ï¸ æ»‘å€’ï¼"; vis.classList.remove('sprinting');
                            }
                        } else {
                            // æ²’åœ¨äº‹ä»¶æ™‚é–“å…§ï¼Œç§»é™¤è¡åˆºå‹•ç•«
                            if (elapsed > ev.t + 1.5) vis.classList.remove('sprinting');
                        }
                    });

                    if (eventType) { bub.innerText = eventType; bub.style.display = "block"; bub.style.background = eventType.includes('âš¡') ? 'var(--sprint)' : '#555'; }
                    else { bub.style.display = "none"; }

                    r.progress += currentSpd * dt;
                    r.stamina = Math.max(0, r.stamina - drain * dt);
                    stam.style.width = r.stamina + "%";
                    stam.style.background = r.stamina < 20 ? 'var(--danger)' : 'var(--success)';

                    if (r.stamina <= 0) { r.isRecovering = true; r.recoveryEndTime = elapsed + 5; }
                }
                el.style.left = (r.progress * finishX) + "px";
                if (r.progress >= 1) { r.finished = true; r.finishTime = elapsed; }
            });

            if (runners.every(r => r.finished)) {
                setTimeout(() => showLeaderboard(runners), 1000);
            } else {
                requestAnimationFrame(frame);
            }
        }
        requestAnimationFrame(frame);
    }

    function showLeaderboard(results) {
        const sorted = [...results].sort((a,b) => a.finishTime - b.finishTime);
        document.getElementById('leaderboard-overlay').style.display = 'flex';
        document.getElementById('rankings-list').innerHTML = sorted.map((r, i) => `
            <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee; font-weight:bold; font-size:18px;">
                <span>#${i+1} ${r.name}</span>
                <span style="color:var(--primary)">${getPrize(i+1)}</span>
            </div>
        `).join('');
    }

    function getPrize(r) {
        if (r === 1) return "$2500";
        if (r <= 5) return "$1000ç¦®åˆ¸";
        return {6:"$500", 7:"$400", 8:"$300", 9:"$200", 10:"$100"}[r] || "-";
    }

    init();
</script>
</body>
</html>
